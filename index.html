<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PlayCode Account Management</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons+Round">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Google+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root {
            /* Enhanced color system */
            --primary-50: #F5F3FF;
            --primary-100: #EDE9FE;
            --primary-200: #DDD6FE;
            --primary-300: #C4B5FD;
            --primary-400: #A78BFA;
            --primary-500: #8B5CF6;
            --primary-600: #7C3AED;
            --primary-700: #6D28D9;
            --primary-800: #5B21B6;
            --primary-900: #4C1D95;
            
            --surface-50: #FAFAFA;
            --surface-100: #F5F5F5;
            --surface-200: #E5E5E5;
            --surface-300: #D4D4D4;
            --surface-400: #A3A3A3;
            --surface-500: #737373;
            --surface-600: #525252;
            --surface-700: #404040;
            --surface-800: #262626;
            --surface-900: #171717;
            
            --success-500: #10B981;
            --warning-500: #F59E0B;
            --error-500: #EF4444;
            --info-500: #3B82F6;
            
            /* Semantic colors */
            --color-primary: var(--primary-600);
            --color-primary-hover: var(--primary-700);
            --color-primary-active: var(--primary-800);
            --color-surface: var(--surface-900);
            --color-surface-variant: var(--surface-800);
            --color-background: var(--surface-900);
            --color-on-primary: #FFFFFF;
            --color-on-surface: var(--surface-50);
            --color-on-surface-variant: var(--surface-400);
            --color-border: var(--surface-700);
            --color-border-hover: var(--surface-600);
            --color-shadow: rgba(0, 0, 0, 0.3);
            --color-overlay: rgba(0, 0, 0, 0.5);
            
            /* Typography */
            --font-family-base: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            --font-family-display: 'Google Sans', var(--font-family-base);
            
            /* Typography scale */
            --text-xs: 0.75rem;
            --text-sm: 0.875rem;
            --text-base: 1rem;
            --text-lg: 1.125rem;
            --text-xl: 1.25rem;
            --text-2xl: 1.5rem;
            --text-3xl: 1.875rem;
            --text-4xl: 2.25rem;
            
            /* Font weights */
            --font-light: 300;
            --font-regular: 400;
            --font-medium: 500;
            --font-semibold: 600;
            --font-bold: 700;
            
            /* Spacing */
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --space-10: 2.5rem;
            --space-12: 3rem;
            --space-16: 4rem;
            
            /* Border radius */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            --radius-full: 9999px;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            
            /* Transitions */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Z-index */
            --z-dropdown: 1000;
            --z-modal: 1050;
            --z-popover: 1070;
            --z-tooltip: 1080;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: var(--font-family-base);
            background-color: var(--color-background);
            color: var(--color-on-surface);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            line-height: 1.5;
        }

        /* Safe area for notches */
        @supports (padding: max(0px)) {
            body {
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }

        /* Google Play Logo Styles */
        .google-play-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #4285F4 0%, #34A853 33%, #FBBC05 66%, #EA4335 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: var(--shadow-md);
        }

        .play-triangle {
            width: 0;
            height: 0;
            border-left: 12px solid white;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            margin-left: 4px;
        }

        /* Auth Pages */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: var(--space-4);
            background: linear-gradient(135deg, var(--primary-900) 0%, var(--primary-700) 100%);
            position: relative;
            overflow: hidden;
        }

        .auth-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(124, 58, 237, 0.1) 0%, transparent 50%);
        }

        .auth-box {
            background: var(--color-surface);
            border-radius: var(--radius-2xl);
            padding: var(--space-8);
            width: 100%;
            max-width: 420px;
            position: relative;
            z-index: 1;
            box-shadow: var(--shadow-2xl);
            border: 1px solid rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
        }

        .auth-header {
            text-align: center;
            margin-bottom: var(--space-8);
        }

        .auth-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
        }

        .auth-logo-text {
            font-family: var(--font-family-display);
            font-size: var(--text-2xl);
            font-weight: var(--font-bold);
            background: linear-gradient(135deg, var(--color-on-surface), var(--color-on-surface-variant));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .auth-header h1 {
            font-size: var(--text-2xl);
            font-weight: var(--font-semibold);
            color: var(--color-on-surface);
            margin-bottom: var(--space-2);
        }

        .auth-subtitle {
            color: var(--color-on-surface-variant);
            font-size: var(--text-sm);
            font-weight: var(--font-regular);
        }

        .form-group {
            margin-bottom: var(--space-6);
        }

        .form-label {
            display: block;
            margin-bottom: var(--space-2);
            color: var(--color-on-surface-variant);
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
        }

        .form-control {
            width: 100%;
            padding: var(--space-4);
            background: var(--color-surface-variant);
            border: 1.5px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: var(--text-base);
            color: var(--color-on-surface);
            transition: all var(--transition-base);
            font-family: inherit;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
            background: var(--color-surface);
        }

        .form-control::placeholder {
            color: var(--color-on-surface-variant);
            opacity: 0.6;
        }

        select.form-control {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%239CA3AF'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right var(--space-4) center;
            background-size: 1.25rem;
            padding-right: var(--space-10);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-4) var(--space-6);
            font-size: var(--text-base);
            font-weight: var(--font-medium);
            border-radius: var(--radius-md);
            border: none;
            cursor: pointer;
            transition: all var(--transition-base);
            text-decoration: none;
            position: relative;
            overflow: hidden;
            font-family: inherit;
            height: 48px;
            min-width: 120px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--color-primary), var(--primary-700));
            color: var(--color-on-primary);
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--color-primary-hover), var(--primary-800));
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--color-surface-variant);
            color: var(--color-on-surface);
            border: 1.5px solid var(--color-border);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--color-surface);
            border-color: var(--color-border-hover);
            transform: translateY(-1px);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--error-500), #DC2626);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: linear-gradient(135deg, #DC2626, #B91C1C);
            transform: translateY(-1px);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-500), #059669);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-500), #D97706);
            color: white;
        }

        .btn-block {
            width: 100%;
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            min-width: auto;
            border-radius: var(--radius-full);
        }

        .btn-loading .btn-text {
            opacity: 0;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            margin: 0;
        }

        /* Typography & Layout */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-left { text-align: left; }

        .text-sm { font-size: var(--text-sm); }
        .text-base { font-size: var(--text-base); }
        .text-lg { font-size: var(--text-lg); }
        .text-xl { font-size: var(--text-xl); }

        .font-light { font-weight: var(--font-light); }
        .font-regular { font-weight: var(--font-regular); }
        .font-medium { font-weight: var(--font-medium); }
        .font-semibold { font-weight: var(--font-semibold); }
        .font-bold { font-weight: var(--font-bold); }

        .text-primary { color: var(--color-primary); }
        .text-success { color: var(--success-500); }
        .text-warning { color: var(--warning-500); }
        .text-error { color: var(--error-500); }
        .text-muted { color: var(--color-on-surface-variant); }

        .mt-1 { margin-top: var(--space-1); }
        .mt-2 { margin-top: var(--space-2); }
        .mt-3 { margin-top: var(--space-3); }
        .mt-4 { margin-top: var(--space-4); }
        .mt-5 { margin-top: var(--space-5); }
        .mt-6 { margin-top: var(--space-6); }
        .mt-8 { margin-top: var(--space-8); }

        .mb-1 { margin-bottom: var(--space-1); }
        .mb-2 { margin-bottom: var(--space-2); }
        .mb-3 { margin-bottom: var(--space-3); }
        .mb-4 { margin-bottom: var(--space-4); }
        .mb-5 { margin-bottom: var(--space-5); }
        .mb-6 { margin-bottom: var(--space-6); }
        .mb-8 { margin-bottom: var(--space-8); }

        .py-2 { padding-top: var(--space-2); padding-bottom: var(--space-2); }
        .py-4 { padding-top: var(--space-4); padding-bottom: var(--space-4); }
        .py-6 { padding-top: var(--space-6); padding-bottom: var(--space-6); }
        .px-4 { padding-left: var(--space-4); padding-right: var(--space-4); }
        .px-6 { padding-left: var(--space-6); padding-right: var(--space-6); }

        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: var(--space-2); }
        .gap-3 { gap: var(--space-3); }
        .gap-4 { gap: var(--space-4); }
        .gap-6 { gap: var(--space-6); }

        .w-full { width: 100%; }
        .max-w-md { max-width: 28rem; }
        .max-w-lg { max-width: 32rem; }
        .max-w-xl { max-width: 36rem; }

        .link {
            color: var(--color-primary);
            text-decoration: none;
            font-weight: var(--font-medium);
            transition: color var(--transition-base);
        }

        .link:hover {
            color: var(--color-primary-hover);
            text-decoration: underline;
        }

        /* Dashboard */
        .dashboard {
            display: none;
            min-height: 100vh;
            background: var(--color-background);
        }

        .header {
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            padding: var(--space-4) var(--space-6);
            position: sticky;
            top: 0;
            z-index: var(--z-dropdown);
            backdrop-filter: blur(10px);
            background: rgba(23, 23, 23, 0.95);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .logo-text {
            font-family: var(--font-family-display);
            font-size: var(--text-xl);
            font-weight: var(--font-bold);
            background: linear-gradient(135deg, var(--color-on-surface), var(--primary-300));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .user-menu {
            position: relative;
        }

        .user-avatar {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-full);
            background: linear-gradient(135deg, var(--primary-500), var(--primary-700));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform var(--transition-base);
            font-weight: var(--font-semibold);
            font-size: var(--text-lg);
            border: 2px solid var(--color-surface);
            box-shadow: var(--shadow-sm);
        }

        .user-avatar:hover {
            transform: scale(1.05);
        }

        .user-avatar:active {
            transform: scale(0.95);
        }

        .dropdown-menu {
            position: absolute;
            top: 52px;
            right: 0;
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            width: 280px;
            max-width: calc(100vw - 2rem);
            display: none;
            z-index: var(--z-dropdown);
            overflow: hidden;
            border: 1px solid var(--color-border);
            animation: slideDown 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            padding: var(--space-4) var(--space-6);
            display: flex;
            align-items: center;
            gap: var(--space-4);
            cursor: pointer;
            transition: background-color var(--transition-fast);
            color: var(--color-on-surface);
            font-size: var(--text-sm);
            border-bottom: 1px solid var(--color-border);
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background-color: var(--color-surface-variant);
        }

        .dropdown-item .material-icons-round {
            font-size: 1.25rem;
            color: var(--color-on-surface-variant);
            width: 24px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-6);
        }

        /* Welcome Section */
        .welcome-section {
            text-align: center;
            padding: var(--space-12) var(--space-6);
            background: linear-gradient(135deg, var(--surface-800), var(--surface-900));
            border-radius: var(--radius-2xl);
            margin-bottom: var(--space-8);
            position: relative;
            overflow: hidden;
            border: 1px solid var(--color-border);
        }

        .welcome-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-500), var(--primary-700));
        }

        .welcome-title {
            font-family: var(--font-family-display);
            font-size: var(--text-3xl);
            font-weight: var(--font-bold);
            background: linear-gradient(135deg, var(--color-on-surface), var(--primary-300));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--space-4);
        }

        .welcome-subtitle {
            color: var(--color-on-surface-variant);
            font-size: var(--text-lg);
            max-width: 600px;
            margin: 0 auto;
        }

        /* Features Grid */
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-6);
        }

        .feature-card {
            background: var(--color-surface);
            padding: var(--space-6);
            border-radius: var(--radius-xl);
            border: 1px solid var(--color-border);
            transition: all var(--transition-base);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            height: 100%;
        }

        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-500), var(--primary-700));
            transform: scaleX(0);
            transition: transform var(--transition-base);
            transform-origin: left;
        }

        .feature-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
            border-color: var(--color-primary);
        }

        .feature-card:hover::before {
            transform: scaleX(1);
        }

        .feature-card:active {
            transform: translateY(-2px);
        }

        .feature-icon {
            width: 64px;
            height: 64px;
            border-radius: var(--radius-lg);
            background: linear-gradient(135deg, var(--primary-500), var(--primary-700));
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: var(--space-4);
            color: white;
            font-size: 1.75rem;
        }

        .feature-title {
            font-size: var(--text-lg);
            font-weight: var(--font-semibold);
            color: var(--color-on-surface);
            margin-bottom: var(--space-2);
        }

        .feature-description {
            color: var(--color-on-surface-variant);
            font-size: var(--text-sm);
            line-height: 1.5;
        }

        /* Tables */
        .table-container {
            background: var(--color-surface);
            border-radius: var(--radius-xl);
            border: 1px solid var(--color-border);
            overflow: hidden;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        thead {
            background: var(--color-surface-variant);
        }

        th {
            padding: var(--space-4) var(--space-6);
            text-align: left;
            font-size: var(--text-sm);
            font-weight: var(--font-semibold);
            color: var(--color-on-surface-variant);
            border-bottom: 1px solid var(--color-border);
            white-space: nowrap;
        }

        td {
            padding: var(--space-4) var(--space-6);
            border-bottom: 1px solid var(--color-border);
            font-size: var(--text-sm);
            color: var(--color-on-surface);
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background: var(--color-surface-variant);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-full);
            font-size: var(--text-xs);
            font-weight: var(--font-medium);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-500);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .status-completed {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-500);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .status-cancelled {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error-500);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .action-buttons {
            display: flex;
            gap: var(--space-2);
            flex-wrap: wrap;
        }

        .action-btn {
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-md);
            font-size: var(--text-xs);
            font-weight: var(--font-medium);
            border: none;
            cursor: pointer;
            transition: all var(--transition-fast);
            white-space: nowrap;
        }

        .action-btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .action-btn-primary:hover {
            background: var(--color-primary-hover);
        }

        .action-btn-danger {
            background: var(--error-500);
            color: white;
        }

        .action-btn-success {
            background: var(--success-500);
            color: white;
        }

        .action-btn-warning {
            background: var(--warning-500);
            color: white;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--color-overlay);
            backdrop-filter: blur(4px);
            z-index: var(--z-modal);
            align-items: center;
            justify-content: center;
            padding: var(--space-4);
            opacity: 0;
            transition: opacity var(--transition-base);
        }

        .modal.show {
            display: flex;
            opacity: 1;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--color-surface);
            border-radius: var(--radius-2xl);
            width: 100%;
            max-width: 440px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-2xl);
            border: 1px solid var(--color-border);
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: var(--space-6) var(--space-6) var(--space-4);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: var(--text-xl);
            font-weight: var(--font-semibold);
            color: var(--color-on-surface);
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--color-on-surface-variant);
            transition: all var(--transition-fast);
        }

        .modal-close:hover {
            background: var(--color-surface-variant);
            color: var(--color-on-surface);
        }

        .modal-body {
            padding: var(--space-6);
        }

        .modal-footer {
            padding: var(--space-4) var(--space-6) var(--space-6);
            border-top: 1px solid var(--color-border);
            display: flex;
            gap: var(--space-3);
            justify-content: flex-end;
        }

        /* Star Rating */
        .star-rating {
            display: flex;
            justify-content: center;
            gap: var(--space-2);
            margin: var(--space-8) 0;
        }

        .star {
            font-size: 2.5rem;
            color: var(--color-border);
            cursor: pointer;
            transition: all var(--transition-base);
            padding: var(--space-1);
            border-radius: var(--radius-md);
        }

        .star:hover {
            color: #FFD700;
            transform: scale(1.1);
            background: rgba(255, 215, 0, 0.1);
        }

        .star.selected {
            color: #FFD700;
        }

        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            min-height: 200px;
            width: 100%;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--color-border);
            border-top: 3px solid var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
            display: block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--color-on-surface-variant);
            font-size: var(--text-sm);
            text-align: center;
        }

        /* Center Balance Display */
        .balance-display {
            text-align: center;
            padding: 30px 0;
        }

        .balance-amount {
            font-size: 48px;
            font-weight: bold;
            color: var(--success-500);
            margin-bottom: 10px;
        }

        /* Admin Panel */
        .admin-container {
            display: none;
            min-height: 100vh;
            background: var(--color-background);
        }

        .admin-header {
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            padding: var(--space-4) var(--space-6);
            position: sticky;
            top: 0;
            z-index: var(--z-dropdown);
            backdrop-filter: blur(10px);
            background: rgba(23, 23, 23, 0.95);
        }

        .admin-header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-title {
            font-family: var(--font-family-display);
            font-size: var(--text-xl);
            font-weight: var(--font-bold);
            background: linear-gradient(135deg, var(--color-on-surface), var(--primary-300));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .section-title {
            font-size: var(--text-2xl);
            font-weight: var(--font-semibold);
            color: var(--color-on-surface);
            margin-bottom: var(--space-6);
            margin-top: var(--space-12);
        }

        .section-title:first-child {
            margin-top: 0;
        }

        /* Transaction History Styles */
        .transactions-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }

        .transaction-item {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            border: 1px solid var(--color-border);
            transition: all var(--transition-fast);
        }

        .transaction-item:hover {
            border-color: var(--color-primary);
            transform: translateY(-2px);
        }

        .transaction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-2);
        }

        .transaction-type {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-full);
            font-size: var(--text-xs);
            font-weight: var(--font-medium);
        }

        .type-deposit {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-500);
        }

        .type-withdrawal {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error-500);
        }

        .type-transfer {
            background: rgba(59, 130, 246, 0.1);
            color: var(--info-500);
        }

        .type-order {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-500);
        }

        .transaction-amount {
            font-weight: var(--font-semibold);
            font-size: var(--text-lg);
        }

        .transaction-details {
            display: flex;
            justify-content: space-between;
            color: var(--color-on-surface-variant);
            font-size: var(--text-sm);
        }

        .transaction-meta {
            display: flex;
            gap: var(--space-3);
        }

        .no-transactions {
            text-align: center;
            padding: var(--space-8);
            color: var(--color-on-surface-variant);
        }

        .filter-controls {
            display: flex;
            gap: var(--space-3);
            margin-bottom: var(--space-6);
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-full);
            background: var(--color-surface-variant);
            border: 1px solid var(--color-border);
            color: var(--color-on-surface);
            cursor: pointer;
            transition: all var(--transition-fast);
            font-size: var(--text-sm);
        }

        .filter-btn.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .filter-btn:hover:not(.active) {
            background: var(--color-surface);
        }

        /* Pay to Friend Styles */
        .user-search {
            position: relative;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            max-height: 300px;
            overflow-y: auto;
            z-index: var(--z-dropdown);
            display: none;
            box-shadow: var(--shadow-lg);
        }

        .search-result-item {
            padding: var(--space-3) var(--space-4);
            cursor: pointer;
            transition: background-color var(--transition-fast);
            border-bottom: 1px solid var(--color-border);
        }

        .search-result-item:hover {
            background-color: var(--color-surface-variant);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .user-avatar-small {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-full);
            background: linear-gradient(135deg, var(--primary-500), var(--primary-700));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: var(--font-semibold);
            font-size: var(--text-sm);
        }

        /* Redeem Code Modal Styles */
        .redeem-code-container {
            text-align: center;
            padding: var(--space-4) 0;
        }

        .redeem-code-display {
            background: var(--color-surface-variant);
            border: 2px dashed var(--color-primary);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            margin: var(--space-4) 0;
            font-family: 'Courier New', monospace;
            font-size: var(--text-xl);
            font-weight: var(--font-bold);
            color: var(--color-on-surface);
            letter-spacing: 2px;
            word-break: break-all;
            position: relative;
        }

        .redeem-code-display:hover {
            background: var(--color-surface);
            border-color: var(--primary-500);
        }

        .redeem-copy-btn {
            position: absolute;
            top: var(--space-2);
            right: var(--space-2);
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .redeem-copy-btn:hover {
            background: var(--color-primary-hover);
            transform: scale(1.1);
        }

        .redeem-copy-btn:active {
            transform: scale(0.95);
        }

        .redeem-instructions {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin-top: var(--space-4);
            text-align: left;
        }

        .redeem-instructions h4 {
            color: var(--success-500);
            margin-bottom: var(--space-2);
            font-size: var(--text-sm);
            font-weight: var(--font-semibold);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .redeem-instructions ul {
            padding-left: var(--space-4);
            color: var(--color-on-surface-variant);
            font-size: var(--text-sm);
        }

        .redeem-instructions li {
            margin-bottom: var(--space-2);
        }

        /* Live Update Indicator */
        .live-indicator {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            color: var(--success-500);
            font-size: var(--text-xs);
            font-weight: var(--font-medium);
            animation: pulse 2s infinite;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background-color: var(--success-500);
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Touch-friendly improvements */
        input, button, select, .feature-card, .dropdown-item {
            min-height: 44px;
            touch-action: manipulation;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            :root {
                --space-4: 0.75rem;
                --space-6: 1rem;
                --space-8: 1.5rem;
                --space-12: 2rem;
            }

            .auth-box {
                padding: var(--space-6);
                margin: var(--space-4);
            }

            .container {
                padding: var(--space-4);
            }

            .welcome-section {
                padding: var(--space-8) var(--space-4);
            }

            .welcome-title {
                font-size: var(--text-2xl);
            }

            .features-grid {
                grid-template-columns: 1fr;
                gap: var(--space-4);
            }

            .header, .admin-header {
                padding: var(--space-3) var(--space-4);
            }

            .modal-content {
                margin: var(--space-4);
                padding: 0;
                max-height: 85vh;
            }

            .dropdown-menu {
                width: calc(100vw - 32px);
                right: var(--space-2);
                max-width: 280px;
            }

            table {
                min-width: 700px;
            }

            .balance-amount {
                font-size: 36px;
            }

            .filter-controls {
                gap: var(--space-2);
            }

            .redeem-code-display {
                font-size: var(--text-lg);
                padding: var(--space-4);
            }
        }

        @media (max-width: 480px) {
            .auth-header h1 {
                font-size: var(--text-xl);
            }

            .modal-content {
                border-radius: var(--radius-xl);
            }

            .star-rating {
                gap: var(--space-1);
            }

            .star {
                font-size: 2rem;
            }

            .action-buttons {
                flex-direction: column;
                align-items: stretch;
            }

            .action-btn {
                width: 100%;
            }

            .balance-amount {
                font-size: 32px;
            }

            .transaction-header {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-2);
            }

            .transaction-details {
                flex-direction: column;
                gap: var(--space-2);
            }

            .redeem-code-display {
                font-size: var(--text-base);
                letter-spacing: 1px;
            }
        }

        /* iOS-specific optimizations */
        @supports (-webkit-touch-callout: none) {
            .auth-container {
                min-height: -webkit-fill-available;
            }

            input, select {
                font-size: 16px;
            }

            .modal {
                padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: var(--space-6);
            right: var(--space-6);
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: var(--space-4) var(--space-6);
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            gap: var(--space-3);
            z-index: var(--z-tooltip);
            transform: translateY(100px);
            opacity: 0;
            transition: all var(--transition-base);
            max-width: 400px;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast-success {
            border-left: 4px solid var(--success-500);
        }

        .toast-error {
            border-left: 4px solid var(--error-500);
        }

        .toast-warning {
            border-left: 4px solid var(--warning-500);
        }

        .toast-info {
            border-left: 4px solid var(--info-500);
        }

        .toast-icon {
            font-size: 1.25rem;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: var(--font-medium);
            color: var(--color-on-surface);
            margin-bottom: var(--space-1);
        }

        .toast-message {
            color: var(--color-on-surface-variant);
            font-size: var(--text-sm);
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--color-on-surface-variant);
            cursor: pointer;
            padding: var(--space-1);
            border-radius: var(--radius-sm);
        }

        .toast-close:hover {
            background: var(--color-surface-variant);
        }
    </style>
</head>
<body>
    <!-- Toast Notification Container -->
    <div id="toastContainer"></div>

    <!-- Redeem Code Modal -->
    <div id="redeemCodeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Redeem Code</h2>
                <button class="modal-close" onclick="closeModal('redeemCodeModal')">×</button>
            </div>
            <div class="modal-body">
                <div class="redeem-code-container">
                    <p class="text-muted mb-4">Your Google Play Redeem Code</p>
                    <div class="redeem-code-display">
                        <span id="redeemCodeValue">Loading...</span>
                        <button class="redeem-copy-btn" onclick="copyRedeemCode()">
                            <span class="material-icons-round" style="font-size: 18px;">content_copy</span>
                        </button>
                    </div>
                    <div class="redeem-instructions">
                        <h4>
                            <span class="material-icons-round" style="font-size: 16px;">info</span>
                            How to use this code:
                        </h4>
                        <ul>
                            <li>Open the Google Play Store app</li>
                            <li>Tap on your profile icon in the top right</li>
                            <li>Select "Payments & subscriptions"</li>
                            <li>Choose "Redeem gift code"</li>
                            <li>Enter the code above and tap "Redeem"</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('redeemCodeModal')">Close</button>
                <button class="btn btn-primary" onclick="copyRedeemCode()">
                    <span class="material-icons-round" style="font-size: 18px;">content_copy</span>
                    Copy Code
                </button>
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="adminModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Admin Login</h2>
                <button class="modal-close" onclick="closeAdminModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">PUKCODE</label>
                    <input type="password" id="pukCode" class="form-control" placeholder="Enter admin PUKCODE" autocomplete="off">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAdminModal()">Cancel</button>
                <button class="btn btn-primary" onclick="adminLogin()">Login as Admin</button>
            </div>
        </div>
    </div>

    <!-- Sign In Page -->
    <div id="signinPage" class="auth-container">
        <div class="auth-box">
            <div class="auth-header">
                <div class="auth-logo">
                    <div class="google-play-logo">
                        <div class="play-triangle"></div>
                    </div>
                    <div class="auth-logo-text">PlayCode</div>
                </div>
                <h1>Welcome Back</h1>
                <p class="auth-subtitle">Sign in to manage your PlayCode account</p>
            </div>
            <form id="signinForm" onsubmit="event.preventDefault(); signIn();">
                <div class="form-group">
                    <label class="form-label">Account Number</label>
                    <input type="text" id="loginAccNo" class="form-control" placeholder="Enter your account number" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label class="form-label">SAR Number</label>
                    <input type="password" id="loginSar" class="form-control" placeholder="Enter your SAR number" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn btn-primary btn-block mt-6" id="signinBtn">
                    <span class="btn-text">Sign In</span>
                </button>
            </form>
            <div class="text-center mt-6">
                <p class="text-sm text-muted">Don't have an account? <a href="#" class="link" onclick="showSignUp()">Create Account</a></p>
                <button class="btn btn-secondary btn-block mt-4" onclick="showAdminModal()">
                    <span class="material-icons-round">admin_panel_settings</span>
                    <span class="btn-text">Admin Access</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Sign Up Page -->
    <div id="signupPage" class="auth-container" style="display: none;">
        <div class="auth-box">
            <div class="auth-header">
                <div class="auth-logo">
                    <div class="google-play-logo">
                        <div class="play-triangle"></div>
                    </div>
                    <div class="auth-logo-text">Create Account</div>
                </div>
                <h1>Join PlayCode</h1>
                <p class="auth-subtitle">Create your account in minutes</p>
            </div>
            <form id="signupForm" onsubmit="event.preventDefault(); signUp();">
                <div class="form-group">
                    <label class="form-label">Account Number</label>
                    <input type="text" id="accNo" class="form-control" placeholder="Enter account number" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label class="form-label">SAR Number</label>
                    <input type="password" id="sarNo" class="form-control" placeholder="Enter SAR number" required autocomplete="new-password">
                </div>
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" id="fullName" class="form-control" placeholder="Enter your full name" required autocomplete="name">
                </div>
                <div class="form-group">
                    <label class="form-label">Agent Code</label>
                    <select id="agentCode" class="form-control" required>
                        <option value="">Select your agent</option>
                        <option value="6215">Agent 6215</option>
                        <option value="3773">Agent 3773</option>
                        <option value="1583">Agent 1583</option>
                        <option value="4848">Agent 4848</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">4-digit PIN</label>
                    <input type="password" id="pin" class="form-control" placeholder="Create a 4-digit PIN" maxlength="4" pattern="\d{4}" required autocomplete="new-password">
                    <p class="text-xs text-muted mt-1">Must be exactly 4 digits</p>
                </div>
                <button type="submit" class="btn btn-primary btn-block mt-6" id="signupBtn">
                    <span class="btn-text">Create Account</span>
                </button>
            </form>
            <div class="text-center mt-6">
                <p class="text-sm text-muted">Already have an account? <a href="#" class="link" onclick="showSignIn()">Sign In</a></p>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <div class="header">
            <div class="header-content">
                <div class="logo">
                    <div class="google-play-logo">
                        <div class="play-triangle"></div>
                    </div>
                    <div class="logo-text">PlayCode Account Management</div>
                </div>
                <div class="user-menu">
                    <div class="user-avatar" onclick="toggleUserMenu()" id="userAvatar">
                        <span id="userInitial">U</span>
                    </div>
                    <div id="userDropdown" class="dropdown-menu">
                        <div class="dropdown-item">
                            <span class="material-icons-round">account_circle</span>
                            <span id="userName">Loading...</span>
                        </div>
                        <div class="dropdown-item">
                            <span class="material-icons-round">account_balance_wallet</span>
                            <span id="balanceDisplay">Balance: ₹0</span>
                        </div>
                        <div class="dropdown-item" onclick="showManageAccount()">
                            <span class="material-icons-round">dashboard</span>
                            <span>Dashboard</span>
                        </div>
                        <div class="dropdown-item" onclick="showMyOrders()">
                            <span class="material-icons-round">receipt_long</span>
                            <span>My Orders</span>
                        </div>
                        <div class="dropdown-item" onclick="showTransactionHistory()">
                            <span class="material-icons-round">history</span>
                            <span>Transaction History</span>
                        </div>
                        <div class="dropdown-item" onclick="logout()">
                            <span class="material-icons-round">logout</span>
                            <span>Sign Out</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="container">
            <div class="welcome-section">
                <h1 class="welcome-title" id="welcomeTitle">Welcome to PlayCode</h1>
                <p class="welcome-subtitle" id="welcomeSubtitle">Manage your Google Play codes seamlessly</p>
            </div>
            
            <div id="manageAccount" class="features-grid">
                <div class="feature-card" onclick="checkBalance()">
                    <div class="feature-icon">
                        <span class="material-icons-round">account_balance_wallet</span>
                    </div>
                    <h3 class="feature-title">Check Balance</h3>
                    <p class="feature-description">View your current account balance and transaction history</p>
                </div>
                <div class="feature-card" onclick="addBalance()">
                    <div class="feature-icon">
                        <span class="material-icons-round">add_circle</span>
                    </div>
                    <h3 class="feature-title">Add Balance</h3>
                    <p class="feature-description">Deposit funds to your account via secure payment</p>
                </div>
                <div class="feature-card" onclick="orderCode()">
                    <div class="feature-icon">
                        <span class="material-icons-round">qr_code_2</span>
                    </div>
                    <h3 class="feature-title">Order Code</h3>
                    <p class="feature-description">Generate new Google Play redemption codes</p>
                </div>
                <div class="feature-card" onclick="payToFriend()">
                    <div class="feature-icon">
                        <span class="material-icons-round">send</span>
                    </div>
                    <h3 class="feature-title">Pay to Friend</h3>
                    <p class="feature-description">Send money to other PlayCode users instantly</p>
                </div>
                <div class="feature-card" onclick="showTransactionHistory()">
                    <div class="feature-icon">
                        <span class="material-icons-round">history</span>
                    </div>
                    <h3 class="feature-title">Transactions</h3>
                    <p class="feature-description">View your complete transaction history</p>
                </div>
                <div class="feature-card" onclick="rateUs()">
                    <div class="feature-icon">
                        <span class="material-icons-round">star_rate</span>
                    </div>
                    <h3 class="feature-title">Feedback</h3>
                    <p class="feature-description">Share your experience and rate our service</p>
                </div>
            </div>

            <!-- Transaction History Section -->
            <div id="transactionHistorySection" style="display: none;">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="section-title">Transaction History</h2>
                    <div class="live-indicator">
                        <div class="live-dot"></div>
                        <span>Live Updates</span>
                    </div>
                </div>
                
                <div class="filter-controls">
                    <button class="filter-btn active" onclick="filterTransactions('all')">All</button>
                    <button class="filter-btn" onclick="filterTransactions('deposit')">Deposits</button>
                    <button class="filter-btn" onclick="filterTransactions('withdrawal')">Withdrawals</button>
                    <button class="filter-btn" onclick="filterTransactions('transfer')">Transfers</button>
                    <button class="filter-btn" onclick="filterTransactions('order')">Orders</button>
                </div>
                
                <div class="transactions-list" id="transactionsList">
                    <!-- Transactions will be loaded here -->
                </div>
            </div>

            <!-- My Orders Section -->
            <div id="myOrdersSection" style="display: none;">
                <h2 class="section-title">My Orders</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Amount</th>
                                <th>Date & Time</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userOrdersTable">
                            <!-- Orders will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="admin-container">
        <div class="admin-header">
            <div class="admin-header-content">
                <div class="logo">
                    <div class="google-play-logo">
                        <div class="play-triangle"></div>
                    </div>
                    <div class="admin-title">Admin Dashboard</div>
                </div>
                <button class="btn btn-danger" onclick="logoutAdmin()">
                    <span class="material-icons-round">logout</span>
                    <span>Logout</span>
                </button>
            </div>
        </div>
        <div class="container">
            <h2 class="section-title">User Management</h2>
            <div class="table-container mb-12">
                <table>
                    <thead>
                        <tr>
                            <th>Account No</th>
                            <th>Full Name</th>
                            <th>Balance</th>
                            <th>Agent Code</th>
                            <th>Joined Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTable">
                        <!-- Users will be loaded here -->
                    </tbody>
                </table>
            </div>

            <h2 class="section-title">All Orders</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Account No</th>
                            <th>Amount</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="allOrdersTable">
                        <!-- All orders will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- All Modals -->
    <!-- Balance Modal - FIXED WITH CENTERED LOADER -->
    <div id="balanceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Account Balance</h2>
                <button class="modal-close" onclick="closeModal('balanceModal')">×</button>
            </div>
            <div class="modal-body">
                <div id="balanceLoading" class="loading">
                    <div class="spinner"></div>
                    <p class="loading-text">Fetching your balance...</p>
                </div>
                <div id="balanceResult" style="display: none;">
                    <div class="balance-display">
                        <div class="balance-amount" id="balanceAmount">₹0</div>
                        <p class="text-muted">Current available balance</p>
                        <div class="mt-6">
                            <button class="btn btn-primary" onclick="addBalance()">Add Funds</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Balance Modal -->
    <div id="addBalanceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Balance</h2>
                <button class="modal-close" onclick="closeModal('addBalanceModal')">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Amount (₹)</label>
                    <input type="number" id="addAmount" class="form-control" placeholder="Enter amount to deposit" min="10" step="10">
                    <p class="text-sm text-muted mt-1">Minimum deposit: ₹10</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addBalanceModal')">Cancel</button>
                <button class="btn btn-primary" onclick="proceedToPayment()">Continue to Payment</button>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Complete Payment</h2>
                <button class="modal-close" onclick="closeModal('paymentModal')">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Transaction Reference</label>
                    <input type="text" id="transactionCode" class="form-control" placeholder="Enter transaction code (e.g., PL018)">
                    <p class="text-sm text-muted mt-1">Enter the reference code provided by your agent</p>
                </div>
                <div class="bg-surface-variant rounded-lg p-4 mt-4">
                    <div class="flex justify-between text-sm mb-2">
                        <span class="text-muted">Payment Amount:</span>
                        <span class="font-semibold" id="paymentAmountDisplay">₹0</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-muted">New Balance:</span>
                        <span class="font-semibold text-success" id="newBalanceDisplay">₹0</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('paymentModal')">Cancel</button>
                <button class="btn btn-primary" onclick="completePayment()">Confirm Payment</button>
            </div>
        </div>
    </div>

    <!-- Order Code Modal -->
    <div id="orderCodeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Generate Code</h2>
                <button class="modal-close" onclick="closeModal('orderCodeModal')">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Amount (₹)</label>
                    <input type="number" id="orderAmount" class="form-control" placeholder="Enter amount for code" min="10" step="10">
                </div>
                <div class="form-group">
                    <label class="form-label">Confirm PIN</label>
                    <input type="password" id="orderPin" class="form-control" placeholder="Enter your 4-digit PIN" maxlength="4" pattern="\d{4}">
                </div>
                <div class="bg-surface-variant rounded-lg p-4">
                    <div class="flex justify-between text-sm mb-2">
                        <span class="text-muted">Current Balance:</span>
                        <span class="font-semibold" id="currentBalanceDisplay">₹0</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-muted">Balance After:</span>
                        <span class="font-semibold" id="balanceAfterDisplay">₹0</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('orderCodeModal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitOrder()">Generate Code</button>
            </div>
        </div>
    </div>

    <!-- Pay to Friend Modal -->
    <div id="payToFriendModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Send Money to Friend</h2>
                <button class="modal-close" onclick="closeModal('payToFriendModal')">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Friend's Account Number</label>
                    <div class="user-search">
                        <input type="text" id="friendAccNo" class="form-control" placeholder="Enter account number" oninput="searchUsers()">
                        <div id="searchResults" class="search-results"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Amount (₹)</label>
                    <input type="number" id="transferAmount" class="form-control" placeholder="Enter amount to send" min="1" oninput="updateTransferSummary()">
                </div>
                <div class="form-group">
                    <label class="form-label">Confirm PIN</label>
                    <input type="password" id="transferPin" class="form-control" placeholder="Enter your 4-digit PIN" maxlength="4" pattern="\d{4}">
                </div>
                <div class="bg-surface-variant rounded-lg p-4">
                    <div id="friendInfo" style="display: none;">
                        <p class="text-sm font-medium mb-2">Sending to: <span id="friendName">Loading...</span></p>
                    </div>
                    <div class="flex justify-between text-sm mb-2">
                        <span class="text-muted">Current Balance:</span>
                        <span class="font-semibold" id="currentTransferBalance">₹0</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-muted">Balance After Transfer:</span>
                        <span class="font-semibold" id="balanceAfterTransfer">₹0</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('payToFriendModal')">Cancel</button>
                <button class="btn btn-primary" onclick="processTransfer()">Send Money</button>
            </div>
        </div>
    </div>

    <!-- Rate Modal -->
    <div id="rateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Rate Our Service</h2>
                <button class="modal-close" onclick="closeModal('rateModal')">×</button>
            </div>
            <div class="modal-body">
                <p class="text-center text-muted mb-6">How was your experience with PlayCode?</p>
                <div class="star-rating" id="starRating">
                    <span class="star material-icons-round" onclick="rate(1)">star_outline</span>
                    <span class="star material-icons-round" onclick="rate(2)">star_outline</span>
                    <span class="star material-icons-round" onclick="rate(3)">star_outline</span>
                    <span class="star material-icons-round" onclick="rate(4)">star_outline</span>
                    <span class="star material-icons-round" onclick="rate(5)">star_outline</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Action Modals -->
    <div id="adminBalanceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Update User Balance</h2>
                <button class="modal-close" onclick="closeModal('adminBalanceModal')">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Action</label>
                    <select id="balanceAction" class="form-control">
                        <option value="add">Add Balance</option>
                        <option value="deduct">Deduct Balance</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Amount (₹)</label>
                    <input type="number" id="adminBalanceAmount" class="form-control" placeholder="Enter amount" min="1">
                </div>
                <div class="bg-surface-variant rounded-lg p-4">
                    <p class="text-sm font-medium mb-1" id="adminUserInfo">User: Loading...</p>
                    <p class="text-sm text-muted" id="adminCurrentBalance">Current Balance: Loading...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('adminBalanceModal')">Cancel</button>
                <button class="btn btn-primary" onclick="updateUserBalance()">Update Balance</button>
            </div>
        </div>
    </div>

    <div id="orderDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Order Management</h2>
                <button class="modal-close" onclick="closeModal('orderDetailsModal')">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Redeem Code</label>
                    <input type="text" id="redeemCode" class="form-control" placeholder="Enter redemption code for user">
                </div>
                <div class="bg-surface-variant rounded-lg p-4 mb-4">
                    <p class="text-sm font-medium mb-2" id="orderInfo">Order: Loading...</p>
                    <p class="text-sm text-muted" id="orderUserInfo">User: Loading...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="cancelOrder()">Cancel Order</button>
                <button class="btn btn-success" onclick="completeOrder()">Complete Order</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC799pLj50Sg877kdBPTIXkJPRGHr4ZC4s",
            authDomain: "playcodesetup.firebaseapp.com",
            databaseURL: "https://playcodesetup-default-rtdb.firebaseio.com",
            projectId: "playcodesetup",
            storageBucket: "playcodesetup.firebasestorage.app",
            messagingSenderId: "548277697840",
            appId: "1:548277697840:web:df6c2524d22ca93d089cf5",
            measurementId: "G-S44Y26B9F5"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Global Variables
        let currentUser = null;
        let currentAdmin = false;
        let selectedUserId = null;
        let selectedOrderId = null;
        let currentRating = 0;
        let paymentAmount = 0;
        let transactionFilter = 'all';
        let realTimeListeners = {};
        let allUsersCache = {};
        let currentRedeemCode = '';

        // Toast Notification System
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const icons = {
                success: 'check_circle',
                error: 'error',
                warning: 'warning',
                info: 'info'
            };
            
            toast.innerHTML = `
                <span class="material-icons-round toast-icon">${icons[type]}</span>
                <div class="toast-content">
                    <div class="toast-title">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">×</button>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (toast.parentElement) {
                            toast.remove();
                        }
                    }, 300);
                }
            }, duration);
        }

        // Initialize Real-time Listeners
        function initRealTimeListeners() {
            if (!currentUser) return;

            // Stop existing listeners
            Object.keys(realTimeListeners).forEach(key => {
                if (realTimeListeners[key]) {
                    realTimeListeners[key]();
                }
            });
            realTimeListeners = {};

            // Listen for user balance changes
            realTimeListeners.balance = database.ref('users/' + currentUser.accNo + '/balance').on('value', (snapshot) => {
                if (snapshot.exists() && currentUser) {
                    const newBalance = snapshot.val();
                    if (newBalance !== currentUser.balance) {
                        const oldBalance = currentUser.balance || 0;
                        currentUser.balance = newBalance;
                        
                        // Update UI
                        updateBalanceDisplay();
                        
                        // Show notification for significant changes
                        const diff = newBalance - oldBalance;
                        if (Math.abs(diff) > 0) {
                            const message = diff > 0 ? 
                                `₹${diff} added to your account` : 
                                `₹${Math.abs(diff)} deducted from your account`;
                            showToast(message, diff > 0 ? 'success' : 'info');
                        }
                    }
                }
            });

            // Listen for transaction updates
            realTimeListeners.transactions = database.ref('transactions').orderByChild('accNo').equalTo(currentUser.accNo).on('value', (snapshot) => {
                if (document.getElementById('transactionHistorySection').style.display !== 'none') {
                    loadTransactionHistory();
                }
            });

            // Listen for order updates
            realTimeListeners.orders = database.ref('orders').orderByChild('accNo').equalTo(currentUser.accNo).on('value', (snapshot) => {
                if (document.getElementById('myOrdersSection').style.display !== 'none') {
                    loadUserOrders();
                }
            });
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('userDropdown');
            const userAvatar = document.querySelector('.user-avatar');
            
            if (dropdown && dropdown.classList.contains('show') && 
                !dropdown.contains(event.target) && 
                !userAvatar.contains(event.target)) {
                dropdown.classList.remove('show');
            }
            
            // Close search results
            const searchResults = document.getElementById('searchResults');
            if (searchResults && searchResults.style.display !== 'none' && 
                !event.target.closest('.user-search')) {
                searchResults.style.display = 'none';
            }
        });

        // Handle back button on mobile
        window.addEventListener('popstate', function() {
            if (currentUser && !currentAdmin) {
                showManageAccount();
            }
        });

        // Authentication Functions
        function showSignUp() {
            document.getElementById('signinPage').style.display = 'none';
            document.getElementById('signupPage').style.display = 'flex';
            window.scrollTo(0, 0);
        }

        function showSignIn() {
            document.getElementById('signupPage').style.display = 'none';
            document.getElementById('signinPage').style.display = 'flex';
            window.scrollTo(0, 0);
        }

        function signUp() {
            const accNo = document.getElementById('accNo').value.trim();
            const sarNo = document.getElementById('sarNo').value.trim();
            const fullName = document.getElementById('fullName').value.trim();
            const agentCode = document.getElementById('agentCode').value;
            const pin = document.getElementById('pin').value;

            if (!accNo || !sarNo || !fullName || !agentCode || !pin || pin.length !== 4 || !/^\d{4}$/.test(pin)) {
                showToast('Please fill all fields correctly. PIN must be exactly 4 digits.', 'error');
                return;
            }

            // Show loading
            const signupBtn = document.getElementById('signupBtn');
            const originalText = signupBtn.innerHTML;
            signupBtn.classList.add('btn-loading');

            // Check if account already exists
            database.ref('users/' + accNo).once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        showToast('Account already exists!', 'error');
                    } else {
                        // Create user
                        const userData = {
                            accNo: accNo,
                            sarNo: sarNo,
                            fullName: fullName,
                            agentCode: agentCode,
                            pin: pin,
                            balance: 0,
                            createdAt: new Date().toISOString(),
                            lastLogin: null,
                            lastTransaction: null
                        };

                        database.ref('users/' + accNo).set(userData)
                            .then(() => {
                                // Create initial transaction record
                                const transactionId = 'TX' + Date.now();
                                const transactionData = {
                                    transactionId: transactionId,
                                    accNo: accNo,
                                    type: 'account_creation',
                                    amount: 0,
                                    description: 'Account created successfully',
                                    date: new Date().toISOString(),
                                    balanceAfter: 0
                                };
                                
                                return database.ref('transactions/' + transactionId).set(transactionData);
                            })
                            .then(() => {
                                showToast('Account created successfully!', 'success');
                                showSignIn();
                                clearSignUpForm();
                            })
                            .catch(error => {
                                showToast('Error creating account: ' + error.message, 'error');
                            })
                            .finally(() => {
                                signupBtn.classList.remove('btn-loading');
                                signupBtn.innerHTML = originalText;
                            });
                    }
                })
                .catch(error => {
                    showToast('Error: ' + error.message, 'error');
                    signupBtn.classList.remove('btn-loading');
                    signupBtn.innerHTML = originalText;
                });
        }

        function signIn() {
            const accNo = document.getElementById('loginAccNo').value.trim();
            const sarNo = document.getElementById('loginSar').value.trim();

            if (!accNo || !sarNo) {
                showToast('Please enter both account number and SAR number', 'error');
                return;
            }

            // Show loading
            const signinBtn = document.getElementById('signinBtn');
            const originalText = signinBtn.innerHTML;
            signinBtn.classList.add('btn-loading');

            database.ref('users/' + accNo).once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        const user = snapshot.val();
                        if (user.sarNo === sarNo) {
                            // Update last login
                            database.ref('users/' + accNo).update({
                                lastLogin: new Date().toISOString()
                            });
                            
                            currentUser = user;
                            showDashboard();
                            loadUserData();
                            initRealTimeListeners(); // Start real-time updates
                            showToast(`Welcome back, ${user.fullName}!`, 'success');
                        } else {
                            showToast('Invalid SAR number!', 'error');
                        }
                    } else {
                        showToast('Account not found!', 'error');
                    }
                })
                .catch(error => {
                    showToast('Error: ' + error.message, 'error');
                })
                .finally(() => {
                    signinBtn.classList.remove('btn-loading');
                    signinBtn.innerHTML = originalText;
                });
        }

        function logout() {
            // Stop all real-time listeners
            Object.keys(realTimeListeners).forEach(key => {
                if (realTimeListeners[key]) {
                    realTimeListeners[key]();
                }
            });
            realTimeListeners = {};
            
            currentUser = null;
            currentAdmin = false;
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('signinPage').style.display = 'flex';
            clearSignInForm();
            showToast('Successfully signed out', 'info');
        }

        // Admin Functions
        function showAdminModal() {
            showModal('adminModal');
        }

        function closeAdminModal() {
            closeModal('adminModal');
            document.getElementById('pukCode').value = '';
        }

        function adminLogin() {
            const pukCode = document.getElementById('pukCode').value;
            if (pukCode === 'PC15836215') {
                currentAdmin = true;
                closeAdminModal();
                showAdminPanel();
                loadAllUsers();
                loadAllOrders();
                showToast('Admin login successful', 'success');
            } else {
                showToast('Invalid PUKCODE!', 'error');
            }
        }

        function logoutAdmin() {
            currentAdmin = false;
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('signinPage').style.display = 'flex';
            showToast('Admin session ended', 'info');
        }

        function showAdminPanel() {
            document.getElementById('signinPage').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            window.scrollTo(0, 0);
        }

        // Dashboard Functions
        function showDashboard() {
            document.getElementById('signinPage').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('myOrdersSection').style.display = 'none';
            document.getElementById('transactionHistorySection').style.display = 'none';
            document.getElementById('manageAccount').style.display = 'grid';
            window.scrollTo(0, 0);
        }

        function toggleUserMenu() {
            document.getElementById('userDropdown').classList.toggle('show');
        }

        function showManageAccount() {
            document.getElementById('myOrdersSection').style.display = 'none';
            document.getElementById('transactionHistorySection').style.display = 'none';
            document.getElementById('manageAccount').style.display = 'grid';
            toggleUserMenu();
        }

        function showMyOrders() {
            document.getElementById('manageAccount').style.display = 'none';
            document.getElementById('transactionHistorySection').style.display = 'none';
            document.getElementById('myOrdersSection').style.display = 'block';
            loadUserOrders();
            toggleUserMenu();
        }

        function showTransactionHistory() {
            document.getElementById('manageAccount').style.display = 'none';
            document.getElementById('myOrdersSection').style.display = 'none';
            document.getElementById('transactionHistorySection').style.display = 'block';
            loadTransactionHistory();
            toggleUserMenu();
        }

        function loadUserData() {
            if (currentUser) {
                // Update user info in dropdown
                document.getElementById('userName').textContent = currentUser.fullName;
                updateBalanceDisplay();
                
                // Update user avatar with initial
                const initial = currentUser.fullName.charAt(0).toUpperCase();
                document.getElementById('userInitial').textContent = initial;
                
                // Update welcome message
                document.getElementById('welcomeTitle').textContent = `Welcome, ${currentUser.fullName}`;
                document.getElementById('welcomeSubtitle').textContent = `Account: ${currentUser.accNo} | Agent: ${currentUser.agentCode}`;
                
                // Update modal balance displays
                document.getElementById('currentBalanceDisplay').textContent = `₹${currentUser.balance || 0}`;
                document.getElementById('currentTransferBalance').textContent = `₹${currentUser.balance || 0}`;
            }
        }

        function updateBalanceDisplay() {
            if (currentUser) {
                const balance = currentUser.balance || 0;
                document.getElementById('balanceDisplay').textContent = `Balance: ₹${balance}`;
                
                // Update balance in transfer modal
                document.getElementById('currentTransferBalance').textContent = `₹${balance}`;
                updateTransferSummary();
            }
        }

        // Transaction History Functions
        function loadTransactionHistory() {
            if (!currentUser) return;
            
            database.ref('transactions').orderByChild('accNo').equalTo(currentUser.accNo).once('value')
                .then(snapshot => {
                    const transactionsList = document.getElementById('transactionsList');
                    transactionsList.innerHTML = '';
                    
                    if (!snapshot.exists()) {
                        transactionsList.innerHTML = `
                            <div class="no-transactions">
                                <p>No transactions found</p>
                            </div>
                        `;
                        return;
                    }
                    
                    let transactions = [];
                    snapshot.forEach(childSnapshot => {
                        const transaction = childSnapshot.val();
                        transaction.id = childSnapshot.key;
                        transactions.push(transaction);
                    });
                    
                    // Sort by date (newest first)
                    transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    // Apply filter
                    const filteredTransactions = transactionFilter === 'all' 
                        ? transactions 
                        : transactions.filter(t => t.type === transactionFilter);
                    
                    if (filteredTransactions.length === 0) {
                        transactionsList.innerHTML = `
                            <div class="no-transactions">
                                <p>No ${transactionFilter} transactions found</p>
                            </div>
                        `;
                        return;
                    }
                    
                    filteredTransactions.forEach(transaction => {
                        const date = new Date(transaction.date).toLocaleString();
                        const typeClass = getTransactionTypeClass(transaction.type);
                        const typeLabel = getTransactionTypeLabel(transaction.type);
                        const isNegative = transaction.type === 'withdrawal' || 
                                          transaction.type === 'transfer_out' || 
                                          transaction.type === 'order';
                        
                        const amountDisplay = `${isNegative ? '-' : '+'}₹${Math.abs(transaction.amount)}`;
                        
                        const transactionItem = document.createElement('div');
                        transactionItem.className = 'transaction-item';
                        transactionItem.innerHTML = `
                            <div class="transaction-header">
                                <div class="transaction-type ${typeClass}">
                                    <span class="material-icons-round" style="font-size: 14px;">${getTransactionIcon(transaction.type)}</span>
                                    <span>${typeLabel}</span>
                                </div>
                                <div class="transaction-amount ${isNegative ? 'text-error' : 'text-success'}">
                                    ${amountDisplay}
                                </div>
                            </div>
                            <p class="text-sm mb-2">${transaction.description || 'Transaction'}</p>
                            <div class="transaction-details">
                                <div class="transaction-meta">
                                    <span>${date}</span>
                                    ${transaction.balanceAfter !== undefined ? 
                                        `<span>Balance: ₹${transaction.balanceAfter}</span>` : ''}
                                </div>
                                ${transaction.referenceId ? 
                                    `<span class="text-muted text-xs">Ref: ${transaction.referenceId}</span>` : ''}
                            </div>
                        `;
                        transactionsList.appendChild(transactionItem);
                    });
                })
                .catch(error => {
                    showToast('Error loading transactions: ' + error.message, 'error');
                });
        }

        function filterTransactions(type) {
            // Update filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            transactionFilter = type;
            loadTransactionHistory();
        }

        function getTransactionTypeClass(type) {
            switch(type) {
                case 'deposit': return 'type-deposit';
                case 'withdrawal': return 'type-withdrawal';
                case 'transfer_in':
                case 'transfer_out': return 'type-transfer';
                case 'order': return 'type-order';
                default: return 'type-deposit';
            }
        }

        function getTransactionTypeLabel(type) {
            switch(type) {
                case 'deposit': return 'Deposit';
                case 'withdrawal': return 'Withdrawal';
                case 'transfer_in': return 'Received';
                case 'transfer_out': return 'Sent';
                case 'order': return 'Order';
                default: return type.replace('_', ' ');
            }
        }

        function getTransactionIcon(type) {
            switch(type) {
                case 'deposit': return 'add_circle';
                case 'withdrawal': return 'remove_circle';
                case 'transfer_in': return 'call_received';
                case 'transfer_out': return 'call_made';
                case 'order': return 'shopping_cart';
                default: return 'receipt';
            }
        }

        // Redeem Code Functions
        function showRedeemCode(code) {
            currentRedeemCode = code;
            document.getElementById('redeemCodeValue').textContent = code;
            showModal('redeemCodeModal');
        }

        function copyRedeemCode() {
            if (!currentRedeemCode) return;
            
            // Create a temporary textarea element
            const textarea = document.createElement('textarea');
            textarea.value = currentRedeemCode;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            
            // Select and copy the text
            textarea.select();
            textarea.setSelectionRange(0, 99999); // For mobile devices
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast('Redeem code copied to clipboard!', 'success');
                } else {
                    showToast('Failed to copy code', 'error');
                }
            } catch (err) {
                // Fallback for older browsers
                try {
                    navigator.clipboard.writeText(currentRedeemCode)
                        .then(() => {
                            showToast('Redeem code copied to clipboard!', 'success');
                        })
                        .catch(() => {
                            showToast('Failed to copy code', 'error');
                        });
                } catch (err2) {
                    showToast('Cannot copy code. Please manually select and copy.', 'warning');
                }
            }
            
            // Clean up
            document.body.removeChild(textarea);
        }

        // Pay to Friend Functions
        function payToFriend() {
            // Clear previous data
            document.getElementById('friendAccNo').value = '';
            document.getElementById('transferAmount').value = '';
            document.getElementById('transferPin').value = '';
            document.getElementById('friendInfo').style.display = 'none';
            
            // Update balance display
            document.getElementById('currentTransferBalance').textContent = `₹${currentUser.balance || 0}`;
            updateTransferSummary();
            
            showModal('payToFriendModal');
        }

        function searchUsers() {
            const searchTerm = document.getElementById('friendAccNo').value.trim();
            const searchResults = document.getElementById('searchResults');
            
            if (searchTerm.length < 2) {
                searchResults.style.display = 'none';
                document.getElementById('friendInfo').style.display = 'none';
                return;
            }
            
            // Clear previous results
            searchResults.innerHTML = '';
            
            // Search in cache first
            if (Object.keys(allUsersCache).length > 0) {
                const filteredUsers = Object.values(allUsersCache).filter(user => 
                    user.accNo.includes(searchTerm) || 
                    user.fullName.toLowerCase().includes(searchTerm.toLowerCase())
                );
                
                displaySearchResults(filteredUsers);
            } else {
                // Load all users from database
                database.ref('users').once('value')
                    .then(snapshot => {
                        if (snapshot.exists()) {
                            snapshot.forEach(childSnapshot => {
                                const user = childSnapshot.val();
                                allUsersCache[user.accNo] = user;
                            });
                            
                            const filteredUsers = Object.values(allUsersCache).filter(user => 
                                user.accNo.includes(searchTerm) || 
                                user.fullName.toLowerCase().includes(searchTerm.toLowerCase())
                            );
                            
                            displaySearchResults(filteredUsers);
                        }
                    })
                    .catch(error => {
                        showToast('Error searching users: ' + error.message, 'error');
                    });
            }
        }

        function displaySearchResults(users) {
            const searchResults = document.getElementById('searchResults');
            
            if (users.length === 0) {
                searchResults.innerHTML = `
                    <div class="search-result-item">
                        <span class="text-muted">No users found</span>
                    </div>
                `;
                searchResults.style.display = 'block';
                return;
            }
            
            users.forEach(user => {
                if (user.accNo === currentUser.accNo) return; // Skip current user
                
                const resultItem = document.createElement('div');
                resultItem.className = 'search-result-item';
                resultItem.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="user-avatar-small">
                            ${user.fullName.charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <div class="font-medium">${user.fullName}</div>
                            <div class="text-xs text-muted">${user.accNo} • Balance: ₹${user.balance || 0}</div>
                        </div>
                    </div>
                `;
                
                resultItem.onclick = () => {
                    selectUserForTransfer(user);
                };
                
                searchResults.appendChild(resultItem);
            });
            
            searchResults.style.display = 'block';
        }

        function selectUserForTransfer(user) {
            document.getElementById('friendAccNo').value = user.accNo;
            document.getElementById('friendName').textContent = `${user.fullName} (${user.accNo})`;
            document.getElementById('friendInfo').style.display = 'block';
            document.getElementById('searchResults').style.display = 'none';
            updateTransferSummary();
        }

        function updateTransferSummary() {
            const amount = parseFloat(document.getElementById('transferAmount').value) || 0;
            const currentBalance = currentUser.balance || 0;
            const balanceAfter = currentBalance - amount;
            
            document.getElementById('balanceAfterTransfer').textContent = `₹${Math.max(0, balanceAfter)}`;
            
            if (amount > currentBalance) {
                document.getElementById('balanceAfterTransfer').classList.add('text-error');
            } else {
                document.getElementById('balanceAfterTransfer').classList.remove('text-error');
            }
        }

        function processTransfer() {
            const friendAccNo = document.getElementById('friendAccNo').value.trim();
            const amount = parseFloat(document.getElementById('transferAmount').value);
            const pin = document.getElementById('transferPin').value;
            
            // Validation
            if (!friendAccNo) {
                showToast('Please enter friend\'s account number', 'error');
                return;
            }
            
            if (!amount || amount <= 0) {
                showToast('Please enter a valid amount', 'error');
                return;
            }
            
            if (friendAccNo === currentUser.accNo) {
                showToast('You cannot transfer money to yourself', 'error');
                return;
            }
            
            if (pin !== currentUser.pin) {
                showToast('Invalid PIN!', 'error');
                return;
            }
            
            const currentBalance = currentUser.balance || 0;
            if (amount > currentBalance) {
                showToast('Insufficient balance!', 'error');
                return;
            }
            
            // Check if friend exists
            database.ref('users/' + friendAccNo).once('value')
                .then(snapshot => {
                    if (!snapshot.exists()) {
                        showToast('Recipient account not found', 'error');
                        return Promise.reject('User not found');
                    }
                    
                    const friend = snapshot.val();
                    const friendBalance = friend.balance || 0;
                    
                    // Generate transaction IDs
                    const timestamp = Date.now();
                    const senderTransactionId = 'TX' + timestamp + 'S';
                    const receiverTransactionId = 'TX' + timestamp + 'R';
                    
                    // Update sender's balance
                    const senderNewBalance = currentBalance - amount;
                    const senderTransaction = {
                        transactionId: senderTransactionId,
                        accNo: currentUser.accNo,
                        type: 'transfer_out',
                        amount: amount,
                        description: `Transfer to ${friend.fullName} (${friendAccNo})`,
                        date: new Date().toISOString(),
                        balanceAfter: senderNewBalance,
                        referenceId: `TRF-${timestamp}`,
                        recipientAccNo: friendAccNo
                    };
                    
                    // Update receiver's balance
                    const receiverNewBalance = friendBalance + amount;
                    const receiverTransaction = {
                        transactionId: receiverTransactionId,
                        accNo: friendAccNo,
                        type: 'transfer_in',
                        amount: amount,
                        description: `Received from ${currentUser.fullName} (${currentUser.accNo})`,
                        date: new Date().toISOString(),
                        balanceAfter: receiverNewBalance,
                        referenceId: `TRF-${timestamp}`,
                        senderAccNo: currentUser.accNo
                    };
                    
                    // Execute transaction as a batch
                    const updates = {};
                    updates[`users/${currentUser.accNo}/balance`] = senderNewBalance;
                    updates[`users/${friendAccNo}/balance`] = receiverNewBalance;
                    updates[`transactions/${senderTransactionId}`] = senderTransaction;
                    updates[`transactions/${receiverTransactionId}`] = receiverTransaction;
                    
                    return database.ref().update(updates);
                })
                .then(() => {
                    // Update local user data
                    currentUser.balance = currentUser.balance - amount;
                    updateBalanceDisplay();
                    
                    // Close modal and show success
                    closeModal('payToFriendModal');
                    showToast(`Successfully transferred ₹${amount} to ${friendAccNo}`, 'success');
                    
                    // Clear form
                    document.getElementById('friendAccNo').value = '';
                    document.getElementById('transferAmount').value = '';
                    document.getElementById('transferPin').value = '';
                    document.getElementById('friendInfo').style.display = 'none';
                    
                    // Reload transaction history
                    if (document.getElementById('transactionHistorySection').style.display !== 'none') {
                        loadTransactionHistory();
                    }
                })
                .catch(error => {
                    if (error !== 'User not found') {
                        showToast('Error processing transfer: ' + error.message, 'error');
                    }
                });
        }

        // Manage Account Functions - FIXED CHECK BALANCE
        function checkBalance() {
            showModal('balanceModal');
            document.getElementById('balanceLoading').style.display = 'flex';
            document.getElementById('balanceResult').style.display = 'none';
            
            // 2 seconds ka delay
            setTimeout(() => {
                document.getElementById('balanceLoading').style.display = 'none';
                document.getElementById('balanceResult').style.display = 'block';
                document.getElementById('balanceAmount').textContent = `₹${currentUser.balance || 0}`;
            }, 2000);
        }

        function addBalance() {
            showModal('addBalanceModal');
        }

        function proceedToPayment() {
            const amountInput = document.getElementById('addAmount');
            const amount = parseFloat(amountInput.value);
            
            if (!amount || amount <= 9) {
                showToast('Please enter a valid amount (minimum ₹10)', 'error');
                amountInput.focus();
                return;
            }
            
            paymentAmount = amount;
            
            // Update payment modal displays
            document.getElementById('paymentAmountDisplay').textContent = `₹${amount}`;
            document.getElementById('newBalanceDisplay').textContent = `₹${(currentUser.balance || 0) + amount}`;
            
            closeModal('addBalanceModal');
            showModal('paymentModal');
        }

        function completePayment() {
            const transactionCode = document.getElementById('transactionCode').value.trim();
            if (!transactionCode) {
                showToast('Please enter transaction code', 'error');
                return;
            }

            const newBalance = (currentUser.balance || 0) + paymentAmount;
            
            // Create transaction record
            const transactionId = 'TX' + Date.now();
            const transactionData = {
                transactionId: transactionId,
                accNo: currentUser.accNo,
                type: 'deposit',
                amount: paymentAmount,
                description: `Deposit via agent - Reference: ${transactionCode}`,
                date: new Date().toISOString(),
                balanceAfter: newBalance,
                referenceId: transactionCode
            };

            // Update user balance and create transaction
            const updates = {};
            updates[`users/${currentUser.accNo}/balance`] = newBalance;
            updates[`transactions/${transactionId}`] = transactionData;
            
            database.ref().update(updates)
                .then(() => {
                    currentUser.balance = newBalance;
                    updateBalanceDisplay();
                    closeModal('paymentModal');
                    showToast(`Successfully added ₹${paymentAmount} to your account`, 'success');
                    
                    // Clear forms
                    document.getElementById('addAmount').value = '';
                    document.getElementById('transactionCode').value = '';
                    
                    // Reload transaction history if open
                    if (document.getElementById('transactionHistorySection').style.display !== 'none') {
                        loadTransactionHistory();
                    }
                })
                .catch(error => {
                    showToast('Error: ' + error.message, 'error');
                });
        }

        function orderCode() {
            // Update balance displays
            document.getElementById('currentBalanceDisplay').textContent = `₹${currentUser.balance || 0}`;
            document.getElementById('orderAmount').value = '';
            document.getElementById('orderPin').value = '';
            
            showModal('orderCodeModal');
        }

        function submitOrder() {
            const amountInput = document.getElementById('orderAmount');
            const pinInput = document.getElementById('orderPin');
            const amount = parseFloat(amountInput.value);
            const pin = pinInput.value;
            
            if (!amount || amount <= 9) {
                showToast('Please enter a valid amount (minimum ₹10)', 'error');
                amountInput.focus();
                return;
            }
            
            if (pin !== currentUser.pin) {
                showToast('Invalid PIN!', 'error');
                pinInput.focus();
                return;
            }
            
            if ((currentUser.balance || 0) < amount) {
                showToast('Insufficient balance!', 'error');
                return;
            }

            // Create order
            const orderId = 'ORD' + Date.now();
            const orderData = {
                orderId: orderId,
                accNo: currentUser.accNo,
                fullName: currentUser.fullName,
                amount: amount,
                status: 'Pending',
                date: new Date().toISOString(),
                agentCode: currentUser.agentCode
            };

            // Create transaction record
            const transactionId = 'TX' + Date.now();
            const transactionData = {
                transactionId: transactionId,
                accNo: currentUser.accNo,
                type: 'order',
                amount: amount,
                description: `Order placed for Google Play code - Order ID: ${orderId}`,
                date: new Date().toISOString(),
                balanceAfter: (currentUser.balance || 0) - amount,
                referenceId: orderId
            };

            // Execute as batch update
            const updates = {};
            updates[`orders/${orderId}`] = orderData;
            updates[`transactions/${transactionId}`] = transactionData;
            updates[`users/${currentUser.accNo}/balance`] = (currentUser.balance || 0) - amount;

            database.ref().update(updates)
                .then(() => {
                    currentUser.balance = (currentUser.balance || 0) - amount;
                    updateBalanceDisplay();
                    closeModal('orderCodeModal');
                    showToast('Order placed successfully! Your code will be available once processed.', 'success');
                    
                    // Clear forms
                    amountInput.value = '';
                    pinInput.value = '';
                    
                    // Reload transaction history if open
                    if (document.getElementById('transactionHistorySection').style.display !== 'none') {
                        loadTransactionHistory();
                    }
                })
                .catch(error => {
                    showToast('Error: ' + error.message, 'error');
                });
        }

        function rateUs() {
            resetStars();
            showModal('rateModal');
        }

        function rate(stars) {
            currentRating = stars;
            const starElements = document.querySelectorAll('#starRating .star');
            starElements.forEach((star, index) => {
                if (index < stars) {
                    star.textContent = 'star';
                    star.classList.add('selected');
                } else {
                    star.textContent = 'star_outline';
                    star.classList.remove('selected');
                }
            });
            
            // Save rating (you could save this to Firebase)
            setTimeout(() => {
                closeModal('rateModal');
                showToast(`Thank you for your ${stars} star rating!`, 'success');
                currentRating = 0;
            }, 1000);
        }

        function resetStars() {
            const starElements = document.querySelectorAll('#starRating .star');
            starElements.forEach(star => {
                star.textContent = 'star_outline';
                star.classList.remove('selected');
            });
        }

        // Admin Functions
        function loadAllUsers() {
            database.ref('users').once('value')
                .then(snapshot => {
                    const usersTable = document.getElementById('usersTable');
                    usersTable.innerHTML = '';
                    
                    if (!snapshot.exists()) {
                        usersTable.innerHTML = `
                            <tr>
                                <td colspan="6" class="text-center py-8 text-muted">
                                    No users found
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    snapshot.forEach(childSnapshot => {
                        const user = childSnapshot.val();
                        const date = user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A';
                        const row = `
                            <tr>
                                <td class="font-medium">${user.accNo}</td>
                                <td>${user.fullName}</td>
                                <td class="font-semibold ${user.balance > 0 ? 'text-success' : 'text-muted'}">₹${user.balance || 0}</td>
                                <td><span class="status-badge">${user.agentCode}</span></td>
                                <td class="text-muted text-sm">${date}</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="action-btn action-btn-primary" 
                                                onclick="showAdminBalanceModal('${user.accNo}')">Balance</button>
                                        <button class="action-btn action-btn-danger" 
                                                onclick="deleteUser('${user.accNo}')">Delete</button>
                                    </div>
                                </td>
                            </tr>
                        `;
                        usersTable.innerHTML += row;
                    });
                })
                .catch(error => {
                    showToast('Error loading users: ' + error.message, 'error');
                });
        }

        function loadAllOrders() {
            database.ref('orders').once('value')
                .then(snapshot => {
                    const ordersTable = document.getElementById('allOrdersTable');
                    ordersTable.innerHTML = '';
                    
                    if (!snapshot.exists()) {
                        ordersTable.innerHTML = `
                            <tr>
                                <td colspan="6" class="text-center py-8 text-muted">
                                    No orders found
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    snapshot.forEach(childSnapshot => {
                        const order = childSnapshot.val();
                        const date = new Date(order.date).toLocaleString();
                        const statusClass = order.status === 'Completed' ? 'status-completed' : 
                                          order.status === 'Cancelled' ? 'status-cancelled' : 'status-pending';
                        
                        const row = `
                            <tr>
                                <td class="font-medium">${order.orderId}</td>
                                <td>${order.accNo}</td>
                                <td class="font-semibold">₹${order.amount}</td>
                                <td class="text-muted text-sm">${date}</td>
                                <td><span class="status-badge ${statusClass}">${order.status}</span></td>
                                <td>
                                    <button class="action-btn action-btn-success" 
                                            onclick="showOrderDetails('${order.orderId}')">Manage</button>
                                </td>
                            </tr>
                        `;
                        ordersTable.innerHTML += row;
                    });
                })
                .catch(error => {
                    showToast('Error loading orders: ' + error.message, 'error');
                });
        }

        function loadUserOrders() {
            if (!currentUser) return;
            
            database.ref('orders').orderByChild('accNo').equalTo(currentUser.accNo).once('value')
                .then(snapshot => {
                    const ordersTable = document.getElementById('userOrdersTable');
                    ordersTable.innerHTML = '';
                    
                    if (!snapshot.exists()) {
                        ordersTable.innerHTML = `
                            <tr>
                                <td colspan="5" class="text-center py-8 text-muted">
                                    No orders found
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    snapshot.forEach(childSnapshot => {
                        const order = childSnapshot.val();
                        const date = new Date(order.date).toLocaleString();
                        const statusClass = order.status === 'Completed' ? 'status-completed' : 
                                          order.status === 'Cancelled' ? 'status-cancelled' : 'status-pending';
                        
                        const redeemButton = order.status === 'Completed' && order.redeemCode ? 
                            `<button class="action-btn action-btn-success" 
                                    onclick="showRedeemCode('${order.redeemCode}')">Show Code</button>` : '';
                        
                        const row = `
                            <tr>
                                <td class="font-medium">${order.orderId}</td>
                                <td class="font-semibold">₹${order.amount}</td>
                                <td class="text-muted text-sm">${date}</td>
                                <td><span class="status-badge ${statusClass}">${order.status}</span></td>
                                <td>${redeemButton}</td>
                            </tr>
                        `;
                        ordersTable.innerHTML += row;
                    });
                })
                .catch(error => {
                    showToast('Error loading orders: ' + error.message, 'error');
                });
        }

        function showAdminBalanceModal(accNo) {
            selectedUserId = accNo;
            
            // Load user info
            database.ref('users/' + accNo).once('value')
                .then(snapshot => {
                    const user = snapshot.val();
                    document.getElementById('adminUserInfo').textContent = `User: ${user.fullName} (${accNo})`;
                    document.getElementById('adminCurrentBalance').textContent = `Current Balance: ₹${user.balance || 0}`;
                    document.getElementById('adminBalanceAmount').value = '';
                    showModal('adminBalanceModal');
                });
        }

        function updateUserBalance() {
            const action = document.getElementById('balanceAction').value;
            const amount = parseFloat(document.getElementById('adminBalanceAmount').value);
            
            if (!amount || amount <= 0) {
                showToast('Please enter a valid amount', 'error');
                return;
            }
            
            database.ref('users/' + selectedUserId).once('value')
                .then(snapshot => {
                    const user = snapshot.val();
                    let newBalance = user.balance || 0;
                    
                    if (action === 'add') {
                        newBalance += amount;
                    } else {
                        newBalance -= amount;
                        if (newBalance < 0) newBalance = 0;
                    }
                    
                    // Create transaction record
                    const transactionId = 'TX' + Date.now();
                    const transactionData = {
                        transactionId: transactionId,
                        accNo: selectedUserId,
                        type: action === 'add' ? 'deposit' : 'withdrawal',
                        amount: amount,
                        description: `Admin ${action === 'add' ? 'added' : 'deducted'} balance`,
                        date: new Date().toISOString(),
                        balanceAfter: newBalance,
                        referenceId: `ADMIN-${Date.now()}`
                    };
                    
                    const updates = {};
                    updates[`users/${selectedUserId}/balance`] = newBalance;
                    updates[`transactions/${transactionId}`] = transactionData;
                    
                    return database.ref().update(updates);
                })
                .then(() => {
                    loadAllUsers();
                    closeModal('adminBalanceModal');
                    showToast(`Balance updated successfully!`, 'success');
                    document.getElementById('adminBalanceAmount').value = '';
                })
                .catch(error => {
                    showToast('Error: ' + error.message, 'error');
                });
        }

        function deleteUser(accNo) {
            if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                database.ref('users/' + accNo).remove()
                    .then(() => {
                        loadAllUsers();
                        showToast('User deleted successfully!', 'success');
                    })
                    .catch(error => {
                        showToast('Error: ' + error.message, 'error');
                    });
            }
        }

        function showOrderDetails(orderId) {
            selectedOrderId = orderId;
            
            // Load order info
            database.ref('orders/' + orderId).once('value')
                .then(snapshot => {
                    const order = snapshot.val();
                    document.getElementById('orderInfo').textContent = `Order: ${orderId} - ₹${order.amount}`;
                    document.getElementById('orderUserInfo').textContent = `User: ${order.fullName} (${order.accNo})`;
                    document.getElementById('redeemCode').value = order.redeemCode || '';
                    showModal('orderDetailsModal');
                });
        }

        function completeOrder() {
            const redeemCode = document.getElementById('redeemCode').value.trim();
            if (!redeemCode) {
                showToast('Please enter redeem code', 'error');
                return;
            }
            
            database.ref('orders/' + selectedOrderId).update({
                status: 'Completed',
                redeemCode: redeemCode,
                completedAt: new Date().toISOString()
            })
            .then(() => {
                loadAllOrders();
                closeModal('orderDetailsModal');
                showToast('Order completed successfully!', 'success');
                document.getElementById('redeemCode').value = '';
            })
            .catch(error => {
                showToast('Error: ' + error.message, 'error');
            });
        }

        function cancelOrder() {
            if (!confirm('Are you sure you want to cancel this order? The amount will be refunded to the user.')) {
                return;
            }
            
            database.ref('orders/' + selectedOrderId).once('value')
                .then(snapshot => {
                    const order = snapshot.val();
                    
                    // Refund balance to user
                    return database.ref('users/' + order.accNo).once('value')
                        .then(userSnapshot => {
                            const user = userSnapshot.val();
                            const newBalance = (user.balance || 0) + order.amount;
                            
                            // Create refund transaction
                            const transactionId = 'TX' + Date.now();
                            const transactionData = {
                                transactionId: transactionId,
                                accNo: order.accNo,
                                type: 'deposit',
                                amount: order.amount,
                                description: `Order cancellation refund - Order ID: ${selectedOrderId}`,
                                date: new Date().toISOString(),
                                balanceAfter: newBalance,
                                referenceId: selectedOrderId
                            };
                            
                            const updates = {};
                            updates[`orders/${selectedOrderId}/status`] = 'Cancelled';
                            updates[`orders/${selectedOrderId}/cancelledAt`] = new Date().toISOString();
                            updates[`users/${order.accNo}/balance`] = newBalance;
                            updates[`transactions/${transactionId}`] = transactionData;
                            
                            return database.ref().update(updates);
                        });
                })
                .then(() => {
                    loadAllOrders();
                    closeModal('orderDetailsModal');
                    showToast('Order cancelled and amount refunded!', 'success');
                })
                .catch(error => {
                    showToast('Error: ' + error.message, 'error');
                });
        }

        // Utility Functions
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
            document.body.style.overflow = 'auto';
        }

        function clearSignUpForm() {
            document.getElementById('accNo').value = '';
            document.getElementById('sarNo').value = '';
            document.getElementById('fullName').value = '';
            document.getElementById('agentCode').value = '';
            document.getElementById('pin').value = '';
        }

        function clearSignInForm() {
            document.getElementById('loginAccNo').value = '';
            document.getElementById('loginSar').value = '';
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('show');
                document.body.style.overflow = 'auto';
            }
        }

        // Handle keyboard on mobile
        window.addEventListener('resize', function() {
            if (window.visualViewport) {
                document.documentElement.style.setProperty('--viewport-height', `${window.visualViewport.height}px`);
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Add input validation
            const numberInputs = document.querySelectorAll('input[type="number"]');
            numberInputs.forEach(input => {
                input.addEventListener('input', function() {
                    if (this.value < 0) this.value = 0;
                });
            });

            // Add form submit handlers
            document.getElementById('signinForm')?.addEventListener('submit', function(e) {
                e.preventDefault();
                signIn();
            });

            document.getElementById('signupForm')?.addEventListener('submit', function(e) {
                e.preventDefault();
                signUp();
            });

            // Initialize transfer amount input listener
            const transferAmountInput = document.getElementById('transferAmount');
            if (transferAmountInput) {
                transferAmountInput.addEventListener('input', updateTransferSummary);
            }
        });
    </script>
</body>
</html>
