<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PlayCode Account Management</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons+Round">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Google+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root {
            /* Enhanced color system */
            --primary-50: #F5F3FF;
            --primary-100: #EDE9FE;
            --primary-200: #DDD6FE;
            --primary-300: #C4B5FD;
            --primary-400: #A78BFA;
            --primary-500: #8B5CF6;
            --primary-600: #7C3AED;
            --primary-700: #6D28D9;
            --primary-800: #5B21B6;
            --primary-900: #4C1D95;
            
            --surface-50: #FAFAFA;
            --surface-100: #F5F5F5;
            --surface-200: #E5E5E5;
            --surface-300: #D4D4D4;
            --surface-400: #A3A3A3;
            --surface-500: #737373;
            --surface-600: #525252;
            --surface-700: #404040;
            --surface-800: #262626;
            --surface-900: #171717;
            
            --success-500: #10B981;
            --warning-500: #F59E0B;
            --error-500: #EF4444;
            --info-500: #3B82F6;
            
            /* Semantic colors */
            --color-primary: var(--primary-600);
            --color-primary-hover: var(--primary-700);
            --color-primary-active: var(--primary-800);
            --color-surface: var(--surface-900);
            --color-surface-variant: var(--surface-800);
            --color-background: var(--surface-900);
            --color-on-primary: #FFFFFF;
            --color-on-surface: var(--surface-50);
            --color-on-surface-variant: var(--surface-400);
            --color-border: var(--surface-700);
            --color-border-hover: var(--surface-600);
            --color-shadow: rgba(0, 0, 0, 0.3);
            --color-overlay: rgba(0, 0, 0, 0.5);
            
            /* Typography */
            --font-family-base: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            --font-family-display: 'Google Sans', var(--font-family-base);
            
            /* Typography scale */
            --text-xs: 0.75rem;
            --text-sm: 0.875rem;
            --text-base: 1rem;
            --text-lg: 1.125rem;
            --text-xl: 1.25rem;
            --text-2xl: 1.5rem;
            --text-3xl: 1.875rem;
            --text-4xl: 2.25rem;
            
            /* Font weights */
            --font-light: 300;
            --font-regular: 400;
            --font-medium: 500;
            --font-semibold: 600;
            --font-bold: 700;
            
            /* Spacing */
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --space-10: 2.5rem;
            --space-12: 3rem;
            --space-16: 4rem;
            
            /* Border radius */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            --radius-full: 9999px;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            
            /* Transitions */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Z-index */
            --z-dropdown: 1000;
            --z-modal: 1050;
            --z-popover: 1070;
            --z-tooltip: 1080;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: var(--font-family-base);
            background-color: var(--color-background);
            color: var(--color-on-surface);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            line-height: 1.5;
        }

        /* Safe area for notches */
        @supports (padding: max(0px)) {
            body {
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }

        /* Google Play Logo Styles */
        .google-play-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #4285F4 0%, #34A853 33%, #FBBC05 66%, #EA4335 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: var(--shadow-md);
        }

        .play-triangle {
            width: 0;
            height: 0;
            border-left: 12px solid white;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            margin-left: 4px;
        }

        /* Auth Pages */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: var(--space-4);
            background: linear-gradient(135deg, var(--primary-900) 0%, var(--primary-700) 100%);
            position: relative;
            overflow: hidden;
        }

        .auth-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(124, 58, 237, 0.1) 0%, transparent 50%);
        }

        .auth-box {
            background: var(--color-surface);
            border-radius: var(--radius-2xl);
            padding: var(--space-8);
            width: 100%;
            max-width: 420px;
            position: relative;
            z-index: 1;
            box-shadow: var(--shadow-2xl);
            border: 1px solid rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
        }

        .auth-header {
            text-align: center;
            margin-bottom: var(--space-8);
        }

        .auth-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
        }

        .auth-logo-text {
            font-family: var(--font-family-display);
            font-size: var(--text-2xl);
            font-weight: var(--font-bold);
            background: linear-gradient(135deg, var(--color-on-surface), var(--color-on-surface-variant));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .auth-header h1 {
            font-size: var(--text-2xl);
            font-weight: var(--font-semibold);
            color: var(--color-on-surface);
            margin-bottom: var(--space-2);
        }

        .auth-subtitle {
            color: var(--color-on-surface-variant);
            font-size: var(--text-sm);
            font-weight: var(--font-regular);
        }

        .form-group {
            margin-bottom: var(--space-6);
        }

        .form-label {
            display: block;
            margin-bottom: var(--space-2);
            color: var(--color-on-surface-variant);
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
        }

        .form-control {
            width: 100%;
            padding: var(--space-4);
            background: var(--color-surface-variant);
            border: 1.5px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: var(--text-base);
            color: var(--color-on-surface);
            transition: all var(--transition-base);
            font-family: inherit;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
            background: var(--color-surface);
        }

        .form-control::placeholder {
            color: var(--color-on-surface-variant);
            opacity: 0.6;
        }

        select.form-control {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%239CA3AF'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right var(--space-4) center;
            background-size: 1.25rem;
            padding-right: var(--space-10);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-4) var(--space-6);
            font-size: var(--text-base);
            font-weight: var(--font-medium);
            border-radius: var(--radius-md);
            border: none;
            cursor: pointer;
            transition: all var(--transition-base);
            text-decoration: none;
            position: relative;
            overflow: hidden;
            font-family: inherit;
            height: 48px;
            min-width: 120px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--color-primary), var(--primary-700));
            color: var(--color-on-primary);
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--color-primary-hover), var(--primary-800));
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--color-surface-variant);
            color: var(--color-on-surface);
            border: 1.5px solid var(--color-border);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--color-surface);
            border-color: var(--color-border-hover);
            transform: translateY(-1px);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--error-500), #DC2626);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: linear-gradient(135deg, #DC2626, #B91C1C);
            transform: translateY(-1px);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-500), #059669);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-500), #D97706);
            color: white;
        }

        .btn-block {
            width: 100%;
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            min-width: auto;
            border-radius: var(--radius-full);
        }

        .btn-loading .btn-text {
            opacity: 0;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            margin: 0;
        }

        /* Typography & Layout */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-left { text-align: left; }

        .text-sm { font-size: var(--text-sm); }
        .text-base { font-size: var(--text-base); }
        .text-lg { font-size: var(--text-lg); }
        .text-xl { font-size: var(--text-xl); }

        .font-light { font-weight: var(--font-light); }
        .font-regular { font-weight: var(--font-regular); }
        .font-medium { font-weight: var(--font-medium); }
        .font-semibold { font-weight: var(--font-semibold); }
        .font-bold { font-weight: var(--font-bold); }

        .text-primary { color: var(--color-primary); }
        .text-success { color: var(--success-500); }
        .text-warning { color: var(--warning-500); }
        .text-error { color: var(--error-500); }
        .text-muted { color: var(--color-on-surface-variant); }

        .mt-1 { margin-top: var(--space-1); }
        .mt-2 { margin-top: var(--space-2); }
        .mt-3 { margin-top: var(--space-3); }
        .mt-4 { margin-top: var(--space-4); }
        .mt-5 { margin-top: var(--space-5); }
        .mt-6 { margin-top: var(--space-6); }
        .mt-8 { margin-top: var(--space-8); }

        .mb-1 { margin-bottom: var(--space-1); }
        .mb-2 { margin-bottom: var(--space-2); }
        .mb-3 { margin-bottom: var(--space-3); }
        .mb-4 { margin-bottom: var(--space-4); }
        .mb-5 { margin-bottom: var(--space-5); }
        .mb-6 { margin-bottom: var(--space-6); }
        .mb-8 { margin-bottom: var(--space-8); }

        .py-2 { padding-top: var(--space-2); padding-bottom: var(--space-2); }
        .py-4 { padding-top: var(--space-4); padding-bottom: var(--space-4); }
        .py-6 { padding-top: var(--space-6); padding-bottom: var(--space-6); }
        .px-4 { padding-left: var(--space-4); padding-right: var(--space-4); }
        .px-6 { padding-left: var(--space-6); padding-right: var(--space-6); }

        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: var(--space-2); }
        .gap-3 { gap: var(--space-3); }
        .gap-4 { gap: var(--space-4); }
        .gap-6 { gap: var(--space-6); }

        .w-full { width: 100%; }
        .max-w-md { max-width: 28rem; }
        .max-w-lg { max-width: 32rem; }
        .max-w-xl { max-width: 36rem; }

        .link {
            color: var(--color-primary);
            text-decoration: none;
            font-weight: var(--font-medium);
            transition: color var(--transition-base);
        }

        .link:hover {
            color: var(--color-primary-hover);
            text-decoration: underline;
        }

        /* Dashboard */
        .dashboard {
            display: none;
            min-height: 100vh;
            background: var(--color-background);
        }

        .header {
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            padding: var(--space-4) var(--space-6);
            position: sticky;
            top: 0;
            z-index: var(--z-dropdown);
            backdrop-filter: blur(10px);
            background: rgba(23, 23, 23, 0.95);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .logo-text {
            font-family: var(--font-family-display);
            font-size: var(--text-xl);
            font-weight: var(--font-bold);
            background: linear-gradient(135deg, var(--color-on-surface), var(--primary-300));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .user-menu {
            position: relative;
        }

        .user-avatar {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-full);
            background: linear-gradient(135deg, var(--primary-500), var(--primary-700));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform var(--transition-base);
            font-weight: var(--font-semibold);
            font-size: var(--text-lg);
            border: 2px solid var(--color-surface);
            box-shadow: var(--shadow-sm);
        }

        .user-avatar:hover {
            transform: scale(1.05);
        }

        .user-avatar:active {
            transform: scale(0.95);
        }

        .dropdown-menu {
            position: absolute;
            top: 52px;
            right: 0;
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            width: 280px;
            max-width: calc(100vw - 2rem);
            display: none;
            z-index: var(--z-dropdown);
            overflow: hidden;
            border: 1px solid var(--color-border);
            animation: slideDown 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            padding: var(--space-4) var(--space-6);
            display: flex;
            align-items: center;
            gap: var(--space-4);
            cursor: pointer;
            transition: background-color var(--transition-fast);
            color: var(--color-on-surface);
            font-size: var(--text-sm);
            border-bottom: 1px solid var(--color-border);
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background-color: var(--color-surface-variant);
        }

        .dropdown-item .material-icons-round {
            font-size: 1.25rem;
            color: var(--color-on-surface-variant);
            width: 24px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-6);
        }

        /* Welcome Section */
        .welcome-section {
            text-align: center;
            padding: var(--space-12) var(--space-6);
            background: linear-gradient(135deg, var(--surface-800), var(--surface-900));
            border-radius: var(--radius-2xl);
            margin-bottom: var(--space-8);
            position: relative;
            overflow: hidden;
            border: 1px solid var(--color-border);
        }

        .welcome-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-500), var(--primary-700));
        }

        .welcome-title {
            font-family: var(--font-family-display);
            font-size: var(--text-3xl);
            font-weight: var(--font-bold);
            background: linear-gradient(135deg, var(--color-on-surface), var(--primary-300));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--space-4);
        }

        .welcome-subtitle {
            color: var(--color-on-surface-variant);
            font-size: var(--text-lg);
            max-width: 600px;
            margin: 0 auto;
        }

        /* Features Grid */
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-6);
        }

        .feature-card {
            background: var(--color-surface);
            padding: var(--space-6);
            border-radius: var(--radius-xl);
            border: 1px solid var(--color-border);
            transition: all var(--transition-base);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            height: 100%;
        }

        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-500), var(--primary-700));
            transform: scaleX(0);
            transition: transform var(--transition-base);
            transform-origin: left;
        }

        .feature-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
            border-color: var(--color-primary);
        }

        .feature-card:hover::before {
            transform: scaleX(1);
        }

        .feature-card:active {
            transform: translateY(-2px);
        }

        .feature-icon {
            width: 64px;
            height: 64px;
            border-radius: var(--radius-lg);
            background: linear-gradient(135deg, var(--primary-500), var(--primary-700));
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: var(--space-4);
            color: white;
            font-size: 1.75rem;
        }

        .feature-title {
            font-size: var(--text-lg);
            font-weight: var(--font-semibold);
            color: var(--color-on-surface);
            margin-bottom: var(--space-2);
        }

        .feature-description {
            color: var(--color-on-surface-variant);
            font-size: var(--text-sm);
            line-height: 1.5;
        }

        /* Tables */
        .table-container {
            background: var(--color-surface);
            border-radius: var(--radius-xl);
            border: 1px solid var(--color-border);
            overflow: hidden;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        thead {
            background: var(--color-surface-variant);
        }

        th {
            padding: var(--space-4) var(--space-6);
            text-align: left;
            font-size: var(--text-sm);
            font-weight: var(--font-semibold);
            color: var(--color-on-surface-variant);
            border-bottom: 1px solid var(--color-border);
            white-space: nowrap;
        }

        td {
            padding: var(--space-4) var(--space-6);
            border-bottom: 1px solid var(--color-border);
            font-size: var(--text-sm);
            color: var(--color-on-surface);
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background: var(--color-surface-variant);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-full);
            font-size: var(--text-xs);
            font-weight: var(--font-medium);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-500);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .status-completed {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-500);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .status-cancelled {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error-500);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .action-buttons {
            display: flex;
            gap: var(--space-2);
            flex-wrap: wrap;
        }

        .action-btn {
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-md);
            font-size: var(--text-xs);
            font-weight: var(--font-medium);
            border: none;
            cursor: pointer;
            transition: all var(--transition-fast);
            white-space: nowrap;
        }

        .action-btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .action-btn-primary:hover {
            background: var(--color-primary-hover);
        }

        .action-btn-danger {
            background: var(--error-500);
            color: white;
        }

        .action-btn-success {
            background: var(--success-500);
            color: white;
        }

        .action-btn-warning {
            background: var(--warning-500);
            color: white;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--color-overlay);
            backdrop-filter: blur(4px);
            z-index: var(--z-modal);
            align-items: center;
            justify-content: center;
            padding: var(--space-4);
            opacity: 0;
            transition: opacity var(--transition-base);
        }

        .modal.show {
            display: flex;
            opacity: 1;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--color-surface);
            border-radius: var(--radius-2xl);
            width: 100%;
            max-width: 440px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-2xl);
            border: 1px solid var(--color-border);
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: var(--space-6) var(--space-6) var(--space-4);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: var(--text-xl);
            font-weight: var(--font-semibold);
            color: var(--color-on-surface);
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--color-on-surface-variant);
            transition: all var(--transition-fast);
        }

        .modal-close:hover {
            background: var(--color-surface-variant);
            color: var(--color-on-surface);
        }

        .modal-body {
            padding: var(--space-6);
        }

        .modal-footer {
            padding: var(--space-4) var(--space-6) var(--space-6);
            border-top: 1px solid var(--color-border);
            display: flex;
            gap: var(--space-3);
            justify-content: flex-end;
        }

        /* Star Rating */
        .star-rating {
            display: flex;
            justify-content: center;
            gap: var(--space-2);
            margin: var(--space-8) 0;
        }

        .star {
            font-size: 2.5rem;
            color: var(--color-border);
            cursor: pointer;
            transition: all var(--transition-base);
            padding: var(--space-1);
            border-radius: var(--radius-md);
        }

        .star:hover {
            color: #FFD700;
            transform: scale(1.1);
            background: rgba(255, 215, 0, 0.1);
        }

        .star.selected {
            color: #FFD700;
        }

        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            min-height: 200px;
            width: 100%;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--color-border);
            border-top: 3px solid var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
            display: block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--color-on-surface-variant);
            font-size: var(--text-sm);
            text-align: center;
        }

        /* Center Balance Display */
        .balance-display {
            text-align: center;
            padding: 30px 0;
        }

        .balance-amount {
            font-size: 48px;
            font-weight: bold;
            color: var(--success-500);
            margin-bottom: 10px;
        }

        /* Admin Panel */
        .admin-container {
            display: none;
            min-height: 100vh;
            background: var(--color-background);
        }

        .admin-header {
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            padding: var(--space-4) var(--space-6);
            position: sticky;
            top: 0;
            z-index: var(--z-dropdown);
            backdrop-filter: blur(10px);
            background: rgba(23, 23, 23, 0.95);
        }

        .admin-header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-title {
            font-family: var(--font-family-display);
            font-size: var(--text-xl);
            font-weight: var(--font-bold);
            background: linear-gradient(135deg, var(--color-on-surface), var(--primary-300));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .section-title {
            font-size: var(--text-2xl);
            font-weight: var(--font-semibold);
            color: var(--color-on-surface);
            margin-bottom: var(--space-6);
            margin-top: var(--space-12);
        }

        .section-title:first-child {
            margin-top: 0;
        }

        /* Touch-friendly improvements */
        input, button, select, .feature-card, .dropdown-item {
            min-height: 44px;
            touch-action: manipulation;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            :root {
                --space-4: 0.75rem;
                --space-6: 1rem;
                --space-8: 1.5rem;
                --space-12: 2rem;
            }

            .auth-box {
                padding: var(--space-6);
                margin: var(--space-4);
            }

            .container {
                padding: var(--space-4);
            }

            .welcome-section {
                padding: var(--space-8) var(--space-4);
            }

            .welcome-title {
                font-size: var(--text-2xl);
            }

            .features-grid {
                grid-template-columns: 1fr;
                gap: var(--space-4);
            }

            .header, .admin-header {
                padding: var(--space-3) var(--space-4);
            }

            .modal-content {
                margin: var(--space-4);
                padding: 0;
                max-height: 85vh;
            }

            .dropdown-menu {
                width: calc(100vw - 32px);
                right: var(--space-2);
                max-width: 280px;
            }

            table {
                min-width: 700px;
            }

            .balance-amount {
                font-size: 36px;
            }
        }

        @media (max-width: 480px) {
            .auth-header h1 {
                font-size: var(--text-xl);
            }

            .modal-content {
                border-radius: var(--radius-xl);
            }

            .star-rating {
                gap: var(--space-1);
            }

            .star {
                font-size: 2rem;
            }

            .action-buttons {
                flex-direction: column;
                align-items: stretch;
            }

            .action-btn {
                width: 100%;
            }

            .balance-amount {
                font-size: 32px;
            }
        }

        /* iOS-specific optimizations */
        @supports (-webkit-touch-callout: none) {
            .auth-container {
                min-height: -webkit-fill-available;
            }

            input, select {
                font-size: 16px;
            }

            .modal {
                padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: var(--space-6);
            right: var(--space-6);
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: var(--space-4) var(--space-6);
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            gap: var(--space-3);
            z-index: var(--z-tooltip);
            transform: translateY(100px);
            opacity: 0;
            transition: all var(--transition-base);
            max-width: 400px;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast-success {
            border-left: 4px solid var(--success-500);
        }

        .toast-error {
            border-left: 4px solid var(--error-500);
        }

        .toast-warning {
            border-left: 4px solid var(--warning-500);
        }

        .toast-info {
            border-left: 4px solid var(--info-500);
        }

        .toast-icon {
            font-size: 1.25rem;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: var(--font-medium);
            color: var(--color-on-surface);
            margin-bottom: var(--space-1);
        }

        .toast-message {
            color: var(--color-on-surface-variant);
            font-size: var(--text-sm);
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--color-on-surface-variant);
            cursor: pointer;
            padding: var(--space-1);
            border-radius: var(--radius-sm);
        }

        .toast-close:hover {
            background: var(--color-surface-variant);
        }
    </style>
</head>
<body>
    <!-- Toast Notification Container -->
    <div id="toastContainer"></div>

    <!-- Admin Login Modal -->
    <div id="adminModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Admin Login</h2>
                <button class="modal-close" onclick="closeAdminModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">PUKCODE</label>
                    <input type="password" id="pukCode" class="form-control" placeholder="Enter admin PUKCODE" autocomplete="off">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAdminModal()">Cancel</button>
                <button class="btn btn-primary" onclick="adminLogin()">Login as Admin</button>
            </div>
        </div>
    </div>

    <!-- Sign In Page -->
    <div id="signinPage" class="auth-container">
        <div class="auth-box">
            <div class="auth-header">
                <div class="auth-logo">
                    <div class="google-play-logo">
                        <div class="play-triangle"></div>
                    </div>
                    <div class="auth-logo-text">PlayCode</div>
                </div>
                <h1>Welcome Back</h1>
                <p class="auth-subtitle">Sign in to manage your PlayCode account</p>
            </div>
            <form id="signinForm" onsubmit="event.preventDefault(); signIn();">
                <div class="form-group">
                    <label class="form-label">Account Number</label>
                    <input type="text" id="loginAccNo" class="form-control" placeholder="Enter your account number" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label class="form-label">SAR Number</label>
                    <input type="password" id="loginSar" class="form-control" placeholder="Enter your SAR number" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn btn-primary btn-block mt-6" id="signinBtn">
                    <span class="btn-text">Sign In</span>
                </button>
            </form>
            <div class="text-center mt-6">
                <p class="text-sm text-muted">Don't have an account? <a href="#" class="link" onclick="showSignUp()">Create Account</a></p>
                <button class="btn btn-secondary btn-block mt-4" onclick="showAdminModal()">
                    <span class="material-icons-round">admin_panel_settings</span>
                    <span class="btn-text">Admin Access</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Sign Up Page -->
    <div id="signupPage" class="auth-container" style="display: none;">
        <div class="auth-box">
            <div class="auth-header">
                <div class="auth-logo">
                    <div class="google-play-logo">
                        <div class="play-triangle"></div>
                    </div>
                    <div class="auth-logo-text">Create Account</div>
                </div>
                <h1>Join PlayCode</h1>
                <p class="auth-subtitle">Create your account in minutes</p>
            </div>
            <form id="signupForm" onsubmit="event.preventDefault(); signUp();">
                <div class="form-group">
                    <label class="form-label">Account Number</label>
                    <input type="text" id="accNo" class="form-control" placeholder="Enter account number" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label class="form-label">SAR Number</label>
                    <input type="password" id="sarNo" class="form-control" placeholder="Enter SAR number" required autocomplete="new-password">
                </div>
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" id="fullName" class="form-control" placeholder="Enter your full name" required autocomplete="name">
                </div>
                <div class="form-group">
                    <label class="form-label">Agent Code</label>
                    <select id="agentCode" class="form-control" required>
                        <option value="">Select your agent</option>
                        <option value="6215">Agent 6215</option>
                        <option value="3773">Agent 3773</option>
                        <option value="1583">Agent 1583</option>
                        <option value="4848">Agent 4848</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">4-digit PIN</label>
                    <input type="password" id="pin" class="form-control" placeholder="Create a 4-digit PIN" maxlength="4" pattern="\d{4}" required autocomplete="new-password">
                    <p class="text-xs text-muted mt-1">Must be exactly 4 digits</p>
                </div>
                <button type="submit" class="btn btn-primary btn-block mt-6" id="signupBtn">
                    <span class="btn-text">Create Account</span>
                </button>
            </form>
            <div class="text-center mt-6">
                <p class="text-sm text-muted">Already have an account? <a href="#" class="link" onclick="showSignIn()">Sign In</a></p>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <div class="header">
            <div class="header-content">
                <div class="logo">
                    <div class="google-play-logo">
                        <div class="play-triangle"></div>
                    </div>
                    <div class="logo-text">PlayCode Account Management</div>
                </div>
                <div class="user-menu">
                    <div class="user-avatar" onclick="toggleUserMenu()" id="userAvatar">
                        <span id="userInitial">U</span>
                    </div>
                    <div id="userDropdown" class="dropdown-menu">
                        <div class="dropdown-item">
                            <span class="material-icons-round">account_circle</span>
                            <span id="userName">Loading...</span>
                        </div>
                        <div class="dropdown-item">
                            <span class="material-icons-round">account_balance_wallet</span>
                            <span id="balanceDisplay">Balance: ₹0</span>
                        </div>
                        <div class="dropdown-item" onclick="showManageAccount()">
                            <span class="material-icons-round">dashboard</span>
                            <span>Dashboard</span>
                        </div>
                        <div class="dropdown-item" onclick="showMyOrders()">
                            <span class="material-icons-round">receipt_long</span>
                            <span>My Orders</span>
                        </div>
                        <div class="dropdown-item" onclick="logout()">
                            <span class="material-icons-round">logout</span>
                            <span>Sign Out</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="container">
            <div class="welcome-section">
                <h1 class="welcome-title" id="welcomeTitle">Welcome to PlayCode</h1>
                <p class="welcome-subtitle" id="welcomeSubtitle">Manage your Google Play codes seamlessly</p>
            </div>
            
            <div id="manageAccount" class="features-grid">
                <div class="feature-card" onclick="checkBalance()">
                    <div class="feature-icon">
                        <span class="material-icons-round">account_balance_wallet</span>
                    </div>
                    <h3 class="feature-title">Check Balance</h3>
                    <p class="feature-description">View your current account balance and transaction history</p>
                </div>
                <div class="feature-card" onclick="addBalance()">
                    <div class="feature-icon">
                        <span class="material-icons-round">add_circle</span>
                    </div>
                    <h3 class="feature-title">Add Balance</h3>
                    <p class="feature-description">Deposit funds to your account via secure payment</p>
                </div>
                <div class="feature-card" onclick="orderCode()">
                    <div class="feature-icon">
                        <span class="material-icons-round">qr_code_2</span>
                    </div>
                    <h3 class="feature-title">Order Code</h3>
                    <p class="feature-description">Generate new Google Play redemption codes</p>
                </div>
                <div class="feature-card" onclick="rateUs()">
                    <div class="feature-icon">
                        <span class="material-icons-round">star_rate</span>
                    </div>
                    <h3 class="feature-title">Feedback</h3>
                    <p class="feature-description">Share your experience and rate our service</p>
                </div>
            </div>

            <!-- My Orders Section -->
            <div id="myOrdersSection" style="display: none;">
                <h2 class="section-title">My Orders</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Amount</th>
                                <th>Date & Time</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userOrdersTable">
                            <!-- Orders will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="admin-container">
        <div class="admin-header">
            <div class="admin-header-content">
                <div class="logo">
                    <div class="google-play-logo">
                        <div class="play-triangle"></div>
                    </div>
                    <div class="admin-title">Admin Dashboard</div>
                </div>
                <button class="btn btn-danger" onclick="logoutAdmin()">
                    <span class="material-icons-round">logout</span>
                    <span>Logout</span>
                </button>
            </div>
        </div>
        <div class="container">
            <h2 class="section-title">User Management</h2>
            <div class="table-container mb-12">
                <table>
                    <thead>
                        <tr>
                            <th>Account No</th>
                            <th>Full Name</th>
                            <th>Balance</th>
                            <th>Agent Code</th>
                            <th>Joined Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTable">
                        <!-- Users will be loaded here -->
                    </tbody>
                </table>
            </div>

            <h2 class="section-title">All Orders</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Account No</th>
                            <th>Amount</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="allOrdersTable">
                        <!-- All orders will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- All Modals -->
    <!-- Balance Modal - FIXED WITH CENTERED LOADER -->
    <div id="balanceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Account Balance</h2>
                <button class="modal-close" onclick="closeModal('balanceModal')">×</button>
            </div>
            <div class="modal-body">
                <div id="balanceLoading" class="loading">
                    <div class="spinner"></div>
                    <p class="loading-text">Fetching your balance...</p>
                </div>
                <div id="balanceResult" style="display: none;">
                    <div class="balance-display">
                        <div class="balance-amount" id="balanceAmount">₹0</div>
                        <p class="text-muted">Current available balance</p>
                        <div class="mt-6">
                            <button class="btn btn-primary" onclick="addBalance()">Add Funds</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Balance Modal -->
    <div id="addBalanceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Balance</h2>
                <button class="modal-close" onclick="closeModal('addBalanceModal')">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Amount (₹)</label>
                    <input type="number" id="addAmount" class="form-control" placeholder="Enter amount to deposit" min="10" step="10">
                    <p class="text-sm text-muted mt-1">Minimum deposit: ₹10</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addBalanceModal')">Cancel</button>
                <button class="btn btn-primary" onclick="proceedToPayment()">Continue to Payment</button>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Complete Payment</h2>
                <button class="modal-close" onclick="closeModal('paymentModal')">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Transaction Reference</label>
                    <input type="text" id="transactionCode" class="form-control" placeholder="Enter transaction code (e.g., PL018)">
                    <p class="text-sm text-muted mt-1">Enter the reference code provided by your agent</p>
                </div>
                <div class="bg-surface-variant rounded-lg p-4 mt-4">
                    <div class="flex justify-between text-sm mb-2">
                        <span class="text-muted">Payment Amount:</span>
                        <span class="font-semibold" id="paymentAmountDisplay">₹0</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-muted">New Balance:</span>
                        <span class="font-semibold text-success" id="newBalanceDisplay">₹0</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('paymentModal')">Cancel</button>
                <button class="btn btn-primary" onclick="completePayment()">Confirm Payment</button>
            </div>
        </div>
    </div>

    <!-- Order Code Modal -->
    <div id="orderCodeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Generate Code</h2>
                <button class="modal-close" onclick="closeModal('orderCodeModal')">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Amount (₹)</label>
                    <input type="number" id="orderAmount" class="form-control" placeholder="Enter amount for code" min="10" step="10">
                </div>
                <div class="form-group">
                    <label class="form-label">Confirm PIN</label>
                    <input type="password" id="orderPin" class="form-control" placeholder="Enter your 4-digit PIN" maxlength="4" pattern="\d{4}">
                </div>
                <div class="bg-surface-variant rounded-lg p-4">
                    <div class="flex justify-between text-sm mb-2">
                        <span class="text-muted">Current Balance:</span>
                        <span class="font-semibold" id="currentBalanceDisplay">₹0</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-muted">Balance After:</span>
                        <span class="font-semibold" id="balanceAfterDisplay">₹0</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('orderCodeModal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitOrder()">Generate Code</button>
            </div>
        </div>
    </div>

    <!-- Rate Modal -->
    <div id="rateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Rate Our Service</h2>
                <button class="modal-close" onclick="closeModal('rateModal')">×</button>
            </div>
            <div class="modal-body">
                <p class="text-center text-muted mb-6">How was your experience with PlayCode?</p>
                <div class="star-rating" id="starRating">
                    <span class="star material-icons-round" onclick="rate(1)">star_outline</span>
                    <span class="star material-icons-round" onclick="rate(2)">star_outline</span>
                    <span class="star material-icons-round" onclick="rate(3)">star_outline</span>
                    <span class="star material-icons-round" onclick="rate(4)">star_outline</span>
                    <span class="star material-icons-round" onclick="rate(5)">star_outline</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Action Modals -->
    <div id="adminBalanceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Update User Balance</h2>
                <button class="modal-close" onclick="closeModal('adminBalanceModal')">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Action</label>
                    <select id="balanceAction" class="form-control">
                        <option value="add">Add Balance</option>
                        <option value="deduct">Deduct Balance</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Amount (₹)</label>
                    <input type="number" id="adminBalanceAmount" class="form-control" placeholder="Enter amount" min="1">
                </div>
                <div class="bg-surface-variant rounded-lg p-4">
                    <p class="text-sm font-medium mb-1" id="adminUserInfo">User: Loading...</p>
                    <p class="text-sm text-muted" id="adminCurrentBalance">Current Balance: Loading...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('adminBalanceModal')">Cancel</button>
                <button class="btn btn-primary" onclick="updateUserBalance()">Update Balance</button>
            </div>
        </div>
    </div>

    <div id="orderDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Order Management</h2>
                <button class="modal-close" onclick="closeModal('orderDetailsModal')">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Redeem Code</label>
                    <input type="text" id="redeemCode" class="form-control" placeholder="Enter redemption code for user">
                </div>
                <div class="bg-surface-variant rounded-lg p-4 mb-4">
                    <p class="text-sm font-medium mb-2" id="orderInfo">Order: Loading...</p>
                    <p class="text-sm text-muted" id="orderUserInfo">User: Loading...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="cancelOrder()">Cancel Order</button>
                <button class="btn btn-success" onclick="completeOrder()">Complete Order</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC799pLj50Sg877kdBPTIXkJPRGHr4ZC4s",
            authDomain: "playcodesetup.firebaseapp.com",
            databaseURL: "https://playcodesetup-default-rtdb.firebaseio.com",
            projectId: "playcodesetup",
            storageBucket: "playcodesetup.firebasestorage.app",
            messagingSenderId: "548277697840",
            appId: "1:548277697840:web:df6c2524d22ca93d089cf5",
            measurementId: "G-S44Y26B9F5"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Global Variables
        let currentUser = null;
        let currentAdmin = false;
        let selectedUserId = null;
        let selectedOrderId = null;
        let currentRating = 0;
        let paymentAmount = 0;

        // Toast Notification System
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const icons = {
                success: 'check_circle',
                error: 'error',
                warning: 'warning',
                info: 'info'
            };
            
            toast.innerHTML = `
                <span class="material-icons-round toast-icon">${icons[type]}</span>
                <div class="toast-content">
                    <div class="toast-title">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">×</button>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (toast.parentElement) {
                            toast.remove();
                        }
                    }, 300);
                }
            }, duration);
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('userDropdown');
            const userAvatar = document.querySelector('.user-avatar');
            
            if (dropdown && dropdown.classList.contains('show') && 
                !dropdown.contains(event.target) && 
                !userAvatar.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Handle back button on mobile
        window.addEventListener('popstate', function() {
            if (currentUser && !currentAdmin) {
                showManageAccount();
            }
        });

        // Form validation
        function validateForm(formId) {
            const form = document.getElementById(formId);
            const inputs = form.querySelectorAll('[required]');
            let isValid = true;
            
            inputs.forEach(input => {
                if (!input.value.trim()) {
                    isValid = false;
                    input.classList.add('error');
                } else {
                    input.classList.remove('error');
                }
            });
            
            return isValid;
        }

        // Authentication Functions
        function showSignUp() {
            document.getElementById('signinPage').style.display = 'none';
            document.getElementById('signupPage').style.display = 'flex';
            window.scrollTo(0, 0);
        }

        function showSignIn() {
            document.getElementById('signupPage').style.display = 'none';
            document.getElementById('signinPage').style.display = 'flex';
            window.scrollTo(0, 0);
        }

        function signUp() {
            const accNo = document.getElementById('accNo').value.trim();
            const sarNo = document.getElementById('sarNo').value.trim();
            const fullName = document.getElementById('fullName').value.trim();
            const agentCode = document.getElementById('agentCode').value;
            const pin = document.getElementById('pin').value;

            if (!accNo || !sarNo || !fullName || !agentCode || !pin || pin.length !== 4 || !/^\d{4}$/.test(pin)) {
                showToast('Please fill all fields correctly. PIN must be exactly 4 digits.', 'error');
                return;
            }

            // Show loading
            const signupBtn = document.getElementById('signupBtn');
            const originalText = signupBtn.innerHTML;
            signupBtn.classList.add('btn-loading');

            // Check if account already exists
            database.ref('users/' + accNo).once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        showToast('Account already exists!', 'error');
                    } else {
                        // Create user
                        const userData = {
                            accNo: accNo,
                            sarNo: sarNo,
                            fullName: fullName,
                            agentCode: agentCode,
                            pin: pin,
                            balance: 0,
                            createdAt: new Date().toISOString(),
                            lastLogin: null
                        };

                        database.ref('users/' + accNo).set(userData)
                            .then(() => {
                                showToast('Account created successfully!', 'success');
                                showSignIn();
                                clearSignUpForm();
                            })
                            .catch(error => {
                                showToast('Error creating account: ' + error.message, 'error');
                            })
                            .finally(() => {
                                signupBtn.classList.remove('btn-loading');
                                signupBtn.innerHTML = originalText;
                            });
                    }
                })
                .catch(error => {
                    showToast('Error: ' + error.message, 'error');
                    signupBtn.classList.remove('btn-loading');
                    signupBtn.innerHTML = originalText;
                });
        }

        function signIn() {
            const accNo = document.getElementById('loginAccNo').value.trim();
            const sarNo = document.getElementById('loginSar').value.trim();

            if (!accNo || !sarNo) {
                showToast('Please enter both account number and SAR number', 'error');
                return;
            }

            // Show loading
            const signinBtn = document.getElementById('signinBtn');
            const originalText = signinBtn.innerHTML;
            signinBtn.classList.add('btn-loading');

            database.ref('users/' + accNo).once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        const user = snapshot.val();
                        if (user.sarNo === sarNo) {
                            // Update last login
                            database.ref('users/' + accNo).update({
                                lastLogin: new Date().toISOString()
                            });
                            
                            currentUser = user;
                            showDashboard();
                            loadUserData();
                            showToast(`Welcome back, ${user.fullName}!`, 'success');
                        } else {
                            showToast('Invalid SAR number!', 'error');
                        }
                    } else {
                        showToast('Account not found!', 'error');
                    }
                })
                .catch(error => {
                    showToast('Error: ' + error.message, 'error');
                })
                .finally(() => {
                    signinBtn.classList.remove('btn-loading');
                    signinBtn.innerHTML = originalText;
                });
        }

        function logout() {
            currentUser = null;
            currentAdmin = false;
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('signinPage').style.display = 'flex';
            clearSignInForm();
            showToast('Successfully signed out', 'info');
        }

        // Admin Functions
        function showAdminModal() {
            showModal('adminModal');
        }

        function closeAdminModal() {
            closeModal('adminModal');
            document.getElementById('pukCode').value = '';
        }

        function adminLogin() {
            const pukCode = document.getElementById('pukCode').value;
            if (pukCode === 'PC15836215') {
                currentAdmin = true;
                closeAdminModal();
                showAdminPanel();
                loadAllUsers();
                loadAllOrders();
                showToast('Admin login successful', 'success');
            } else {
                showToast('Invalid PUKCODE!', 'error');
            }
        }

        function logoutAdmin() {
            currentAdmin = false;
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('signinPage').style.display = 'flex';
            showToast('Admin session ended', 'info');
        }

        function showAdminPanel() {
            document.getElementById('signinPage').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            window.scrollTo(0, 0);
        }

        // Dashboard Functions
        function showDashboard() {
            document.getElementById('signinPage').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('myOrdersSection').style.display = 'none';
            document.getElementById('manageAccount').style.display = 'grid';
            window.scrollTo(0, 0);
        }

        function toggleUserMenu() {
            document.getElementById('userDropdown').classList.toggle('show');
        }

        function showManageAccount() {
            document.getElementById('myOrdersSection').style.display = 'none';
            document.getElementById('manageAccount').style.display = 'grid';
            toggleUserMenu();
        }

        function showMyOrders() {
            document.getElementById('manageAccount').style.display = 'none';
            document.getElementById('myOrdersSection').style.display = 'block';
            loadUserOrders();
            toggleUserMenu();
        }

        function loadUserData() {
            if (currentUser) {
                // Update user info in dropdown
                document.getElementById('userName').textContent = currentUser.fullName;
                document.getElementById('balanceDisplay').textContent = `Balance: ₹${currentUser.balance || 0}`;
                
                // Update user avatar with initial
                const initial = currentUser.fullName.charAt(0).toUpperCase();
                document.getElementById('userInitial').textContent = initial;
                
                // Update welcome message
                document.getElementById('welcomeTitle').textContent = `Welcome, ${currentUser.fullName}`;
                document.getElementById('welcomeSubtitle').textContent = `Account: ${currentUser.accNo} | Agent: ${currentUser.agentCode}`;
                
                // Update order modal balance display
                document.getElementById('currentBalanceDisplay').textContent = `₹${currentUser.balance || 0}`;
            }
        }

        // Manage Account Functions - FIXED CHECK BALANCE
        function checkBalance() {
            showModal('balanceModal');
            document.getElementById('balanceLoading').style.display = 'flex';
            document.getElementById('balanceResult').style.display = 'none';
            
            // 2 seconds ka delay
            setTimeout(() => {
                document.getElementById('balanceLoading').style.display = 'none';
                document.getElementById('balanceResult').style.display = 'block';
                document.getElementById('balanceAmount').textContent = `₹${currentUser.balance || 0}`;
            }, 2000);
        }

        function addBalance() {
            showModal('addBalanceModal');
        }

        function proceedToPayment() {
            const amountInput = document.getElementById('addAmount');
            const amount = parseFloat(amountInput.value);
            
            if (!amount || amount <= 9) {
                showToast('Please enter a valid amount (minimum ₹10)', 'error');
                amountInput.focus();
                return;
            }
            
            paymentAmount = amount;
            
            // Update payment modal displays
            document.getElementById('paymentAmountDisplay').textContent = `₹${amount}`;
            document.getElementById('newBalanceDisplay').textContent = `₹${(currentUser.balance || 0) + amount}`;
            
            closeModal('addBalanceModal');
            showModal('paymentModal');
        }

        function completePayment() {
            const transactionCode = document.getElementById('transactionCode').value.trim();
            if (!transactionCode) {
                showToast('Please enter transaction code', 'error');
                return;
            }

            // Update user balance
            const newBalance = (currentUser.balance || 0) + paymentAmount;
            database.ref('users/' + currentUser.accNo).update({
                balance: newBalance,
                lastTransaction: {
                    code: transactionCode,
                    amount: paymentAmount,
                    type: 'deposit',
                    date: new Date().toISOString()
                }
            })
            .then(() => {
                currentUser.balance = newBalance;
                loadUserData();
                closeModal('paymentModal');
                showToast(`Successfully added ₹${paymentAmount} to your account`, 'success');
                
                // Clear forms
                document.getElementById('addAmount').value = '';
                document.getElementById('transactionCode').value = '';
            })
            .catch(error => {
                showToast('Error: ' + error.message, 'error');
            });
        }

        function orderCode() {
            // Update balance displays
            document.getElementById('currentBalanceDisplay').textContent = `₹${currentUser.balance || 0}`;
            document.getElementById('orderAmount').value = '';
            document.getElementById('orderPin').value = '';
            
            showModal('orderCodeModal');
        }

        function submitOrder() {
            const amountInput = document.getElementById('orderAmount');
            const pinInput = document.getElementById('orderPin');
            const amount = parseFloat(amountInput.value);
            const pin = pinInput.value;
            
            if (!amount || amount <= 9) {
                showToast('Please enter a valid amount (minimum ₹10)', 'error');
                amountInput.focus();
                return;
            }
            
            if (pin !== currentUser.pin) {
                showToast('Invalid PIN!', 'error');
                pinInput.focus();
                return;
            }
            
            if ((currentUser.balance || 0) < amount) {
                showToast('Insufficient balance!', 'error');
                return;
            }

            // Create order
            const orderId = 'ORD' + Date.now();
            const orderData = {
                orderId: orderId,
                accNo: currentUser.accNo,
                fullName: currentUser.fullName,
                amount: amount,
                status: 'Pending',
                date: new Date().toISOString(),
                agentCode: currentUser.agentCode
            };

            database.ref('orders/' + orderId).set(orderData)
                .then(() => {
                    // Deduct balance
                    const newBalance = (currentUser.balance || 0) - amount;
                    return database.ref('users/' + currentUser.accNo).update({
                        balance: newBalance
                    });
                })
                .then(() => {
                    currentUser.balance = (currentUser.balance || 0) - amount;
                    loadUserData();
                    closeModal('orderCodeModal');
                    showToast('Order placed successfully! Your code will be available once processed.', 'success');
                    
                    // Clear forms
                    amountInput.value = '';
                    pinInput.value = '';
                })
                .catch(error => {
                    showToast('Error: ' + error.message, 'error');
                });
        }

        function rateUs() {
            resetStars();
            showModal('rateModal');
        }

        function rate(stars) {
            currentRating = stars;
            const starElements = document.querySelectorAll('#starRating .star');
            starElements.forEach((star, index) => {
                if (index < stars) {
                    star.textContent = 'star';
                    star.classList.add('selected');
                } else {
                    star.textContent = 'star_outline';
                    star.classList.remove('selected');
                }
            });
            
            // Save rating (you could save this to Firebase)
            setTimeout(() => {
                closeModal('rateModal');
                showToast(`Thank you for your ${stars} star rating!`, 'success');
                currentRating = 0;
            }, 1000);
        }

        function resetStars() {
            const starElements = document.querySelectorAll('#starRating .star');
            starElements.forEach(star => {
                star.textContent = 'star_outline';
                star.classList.remove('selected');
            });
        }

        // Admin Functions
        function loadAllUsers() {
            database.ref('users').once('value')
                .then(snapshot => {
                    const usersTable = document.getElementById('usersTable');
                    usersTable.innerHTML = '';
                    
                    if (!snapshot.exists()) {
                        usersTable.innerHTML = `
                            <tr>
                                <td colspan="6" class="text-center py-8 text-muted">
                                    No users found
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    snapshot.forEach(childSnapshot => {
                        const user = childSnapshot.val();
                        const date = user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A';
                        const row = `
                            <tr>
                                <td class="font-medium">${user.accNo}</td>
                                <td>${user.fullName}</td>
                                <td class="font-semibold ${user.balance > 0 ? 'text-success' : 'text-muted'}">₹${user.balance || 0}</td>
                                <td><span class="status-badge">${user.agentCode}</span></td>
                                <td class="text-muted text-sm">${date}</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="action-btn action-btn-primary" 
                                                onclick="showAdminBalanceModal('${user.accNo}')">Balance</button>
                                        <button class="action-btn action-btn-danger" 
                                                onclick="deleteUser('${user.accNo}')">Delete</button>
                                    </div>
                                </td>
                            </tr>
                        `;
                        usersTable.innerHTML += row;
                    });
                })
                .catch(error => {
                    showToast('Error loading users: ' + error.message, 'error');
                });
        }

        function loadAllOrders() {
            database.ref('orders').once('value')
                .then(snapshot => {
                    const ordersTable = document.getElementById('allOrdersTable');
                    ordersTable.innerHTML = '';
                    
                    if (!snapshot.exists()) {
                        ordersTable.innerHTML = `
                            <tr>
                                <td colspan="6" class="text-center py-8 text-muted">
                                    No orders found
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    snapshot.forEach(childSnapshot => {
                        const order = childSnapshot.val();
                        const date = new Date(order.date).toLocaleString();
                        const statusClass = order.status === 'Completed' ? 'status-completed' : 
                                          order.status === 'Cancelled' ? 'status-cancelled' : 'status-pending';
                        
                        const row = `
                            <tr>
                                <td class="font-medium">${order.orderId}</td>
                                <td>${order.accNo}</td>
                                <td class="font-semibold">₹${order.amount}</td>
                                <td class="text-muted text-sm">${date}</td>
                                <td><span class="status-badge ${statusClass}">${order.status}</span></td>
                                <td>
                                    <button class="action-btn action-btn-success" 
                                            onclick="showOrderDetails('${order.orderId}')">Manage</button>
                                </td>
                            </tr>
                        `;
                        ordersTable.innerHTML += row;
                    });
                })
                .catch(error => {
                    showToast('Error loading orders: ' + error.message, 'error');
                });
        }

        function loadUserOrders() {
            if (!currentUser) return;
            
            database.ref('orders').orderByChild('accNo').equalTo(currentUser.accNo).once('value')
                .then(snapshot => {
                    const ordersTable = document.getElementById('userOrdersTable');
                    ordersTable.innerHTML = '';
                    
                    if (!snapshot.exists()) {
                        ordersTable.innerHTML = `
                            <tr>
                                <td colspan="5" class="text-center py-8 text-muted">
                                    No orders found
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    snapshot.forEach(childSnapshot => {
                        const order = childSnapshot.val();
                        const date = new Date(order.date).toLocaleString();
                        const statusClass = order.status === 'Completed' ? 'status-completed' : 
                                          order.status === 'Cancelled' ? 'status-cancelled' : 'status-pending';
                        
                        const redeemButton = order.status === 'Completed' && order.redeemCode ? 
                            `<button class="action-btn action-btn-success" 
                                    onclick="showRedeemCode('${order.redeemCode}')">Show Code</button>` : '';
                        
                        const row = `
                            <tr>
                                <td class="font-medium">${order.orderId}</td>
                                <td class="font-semibold">₹${order.amount}</td>
                                <td class="text-muted text-sm">${date}</td>
                                <td><span class="status-badge ${statusClass}">${order.status}</span></td>
                                <td>${redeemButton}</td>
                            </tr>
                        `;
                        ordersTable.innerHTML += row;
                    });
                })
                .catch(error => {
                    showToast('Error loading orders: ' + error.message, 'error');
                });
        }

        function showAdminBalanceModal(accNo) {
            selectedUserId = accNo;
            
            // Load user info
            database.ref('users/' + accNo).once('value')
                .then(snapshot => {
                    const user = snapshot.val();
                    document.getElementById('adminUserInfo').textContent = `User: ${user.fullName} (${accNo})`;
                    document.getElementById('adminCurrentBalance').textContent = `Current Balance: ₹${user.balance || 0}`;
                    document.getElementById('adminBalanceAmount').value = '';
                    showModal('adminBalanceModal');
                });
        }

        function updateUserBalance() {
            const action = document.getElementById('balanceAction').value;
            const amount = parseFloat(document.getElementById('adminBalanceAmount').value);
            
            if (!amount || amount <= 0) {
                showToast('Please enter a valid amount', 'error');
                return;
            }
            
            database.ref('users/' + selectedUserId).once('value')
                .then(snapshot => {
                    const user = snapshot.val();
                    let newBalance = user.balance || 0;
                    
                    if (action === 'add') {
                        newBalance += amount;
                    } else {
                        newBalance -= amount;
                        if (newBalance < 0) newBalance = 0;
                    }
                    
                    return database.ref('users/' + selectedUserId).update({
                        balance: newBalance
                    });
                })
                .then(() => {
                    loadAllUsers();
                    closeModal('adminBalanceModal');
                    showToast(`Balance updated successfully!`, 'success');
                    document.getElementById('adminBalanceAmount').value = '';
                })
                .catch(error => {
                    showToast('Error: ' + error.message, 'error');
                });
        }

        function deleteUser(accNo) {
            if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                database.ref('users/' + accNo).remove()
                    .then(() => {
                        loadAllUsers();
                        showToast('User deleted successfully!', 'success');
                    })
                    .catch(error => {
                        showToast('Error: ' + error.message, 'error');
                    });
            }
        }

        function showOrderDetails(orderId) {
            selectedOrderId = orderId;
            
            // Load order info
            database.ref('orders/' + orderId).once('value')
                .then(snapshot => {
                    const order = snapshot.val();
                    document.getElementById('orderInfo').textContent = `Order: ${orderId} - ₹${order.amount}`;
                    document.getElementById('orderUserInfo').textContent = `User: ${order.fullName} (${order.accNo})`;
                    document.getElementById('redeemCode').value = order.redeemCode || '';
                    showModal('orderDetailsModal');
                });
        }

        function completeOrder() {
            const redeemCode = document.getElementById('redeemCode').value.trim();
            if (!redeemCode) {
                showToast('Please enter redeem code', 'error');
                return;
            }
            
            database.ref('orders/' + selectedOrderId).update({
                status: 'Completed',
                redeemCode: redeemCode,
                completedAt: new Date().toISOString()
            })
            .then(() => {
                loadAllOrders();
                closeModal('orderDetailsModal');
                showToast('Order completed successfully!', 'success');
                document.getElementById('redeemCode').value = '';
            })
            .catch(error => {
                showToast('Error: ' + error.message, 'error');
            });
        }

        function cancelOrder() {
            if (!confirm('Are you sure you want to cancel this order? The amount will be refunded to the user.')) {
                return;
            }
            
            database.ref('orders/' + selectedOrderId).update({
                status: 'Cancelled',
                cancelledAt: new Date().toISOString()
            })
            .then(() => {
                // Refund balance to user
                return database.ref('orders/' + selectedOrderId).once('value');
            })
            .then(snapshot => {
                const order = snapshot.val();
                return database.ref('users/' + order.accNo).once('value');
            })
            .then(userSnapshot => {
                const user = userSnapshot.val();
                const newBalance = (user.balance || 0) + userSnapshot.val().amount;
                
                return database.ref('users/' + userSnapshot.val().accNo).update({
                    balance: newBalance
                });
            })
            .then(() => {
                loadAllOrders();
                closeModal('orderDetailsModal');
                showToast('Order cancelled and amount refunded!', 'success');
            })
            .catch(error => {
                showToast('Error: ' + error.message, 'error');
            });
        }

        function showRedeemCode(code) {
            alert(`Your redeem code is:\n\n${code}\n\nPlease use this code to redeem your Google Play credit.`);
        }

        // Utility Functions
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
            document.body.style.overflow = 'auto';
        }

        function clearSignUpForm() {
            document.getElementById('accNo').value = '';
            document.getElementById('sarNo').value = '';
            document.getElementById('fullName').value = '';
            document.getElementById('agentCode').value = '';
            document.getElementById('pin').value = '';
        }

        function clearSignInForm() {
            document.getElementById('loginAccNo').value = '';
            document.getElementById('loginSar').value = '';
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('show');
                document.body.style.overflow = 'auto';
            }
        }

        // Handle keyboard on mobile
        window.addEventListener('resize', function() {
            if (window.visualViewport) {
                document.documentElement.style.setProperty('--viewport-height', `${window.visualViewport.height}px`);
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Add input validation
            const numberInputs = document.querySelectorAll('input[type="number"]');
            numberInputs.forEach(input => {
                input.addEventListener('input', function() {
                    if (this.value < 0) this.value = 0;
                });
            });

            // Add form submit handlers
            document.getElementById('signinForm')?.addEventListener('submit', function(e) {
                e.preventDefault();
                signIn();
            });

            document.getElementById('signupForm')?.addEventListener('submit', function(e) {
                e.preventDefault();
                signUp();
            });
        });
    </script>
</body>
</html>
